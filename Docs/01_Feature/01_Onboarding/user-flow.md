# 온보딩 시스템 - 사용자 플로우 v2.0

## 플로우 다이어그램

```
[최초 접속]
    ↓
[재방문 확인 (localStorage)]
    ↓
    ├─ [신규 사용자] ─────────────────────────┐
    │                                         ↓
    │                            [메인 화면 즉시 진입]
    │                            (모든 방 블랙아웃)
    │                                         ↓
    │                         [0.5초 대기 → 1F 방 페이드인 시작]
    │                                         ↓
    │                         [3초 애니메이션 (서서히 밝아짐)]
    │                                         ↓
    │                         [애니메이션 완료 → 1F 방 선택]
    │                                         ↓
    │                         [룸메이트 첫 인사 메시지]
    │                         [좌측 팝업: 서비스 소개]
    │                                         ↓
    │                              [이름 입력 단계]
    │                                         ↓
    │                              [나이 입력 단계]
    │                                         ↓
    │                         [개인정보 동의 팝업]
    │                                         ↓
    │                          [이용약관 동의 팝업]
    │                                         ↓
    │                           [노크 가이드 팝업]
    │                                         ↓
    │                          [온보딩 완료 저장]
    │                                         ↓
    │                    [정상 플레이 상태 (노크 가능)]
    │
    └─ [재방문 사용자] → [메인 화면 (정상 상태)]
```

---

## 상세 단계별 플로우

### Step 0: 최초 접속 및 재방문 확인

**트리거**: 사용자가 서비스 URL 접속

**재방문 확인 로직**:
```typescript
// localStorage 확인
const hasCompletedOnboarding = localStorage.getItem('knockOnboardingComplete')

if (hasCompletedOnboarding === 'true') {
  // 재방문 사용자
  dispatch({ type: 'SKIP_ONBOARDING' })
  // 1F 방 이미 공개된 상태로 시작
} else {
  // 신규 사용자
  dispatch({ type: 'START_ONBOARDING' })
  // 모든 방 블랙아웃 상태
}
```

**화면 전환**:
- 신규 사용자 → 메인 화면 (온보딩 모드)
- 재방문 사용자 → 메인 화면 (정상 모드)

---

### Step 1: 방 밝아지기 애니메이션 (신규 사용자만)

**타이밍 플로우**:
```
[0초] 메인 화면 렌더링 완료
  ↓
[0.5초] 애니메이션 시작 트리거
  ↓
[0.5 ~ 3.5초] 1F 방 페이드인 애니메이션
  - opacity: 0 → 1
  - background: gray → blue
  - 룸메이트 아바타 나타남
  ↓
[3.5초] 애니메이션 완료
  ↓
[자동] 1F 방 선택됨
  ↓
[4초] 첫 번째 채팅 메시지 등장
```

**사용자 인터랙션**: 없음 (자동 진행)

**UI 상태 변화**:
| 시간 | 1F 방 상태 | 우측 채팅창 | 좌측 팝업 |
|------|-----------|------------|----------|
| 0초 | 블랙아웃 | 비활성 | 없음 |
| 0.5초 | 페이드인 시작 | 비활성 | 없음 |
| 3.5초 | 완전히 밝아짐 | 활성화 | 없음 |
| 4초 | 선택됨 (노란 테두리) | 메시지 표시 | 서비스 소개 표시 |

---

### Step 2: 첫 인사 (greeting)

**화면 구성**:
```
┌─────────────────────────────────────────────┐
│  [좌측: 빌딩 영역]      [우측: 채팅 영역]    │
│                                             │
│  ┌──────────────┐      ┌──────────────┐    │
│  │ [팝업 오버레이]│     │ [채팅 헤더]   │    │
│  │              │      │ 🏠 내 룸메이트 │    │
│  │ Knock에      │      │              │    │
│  │ 오신 걸      │      ├──────────────┤    │
│  │ 환영합니다   │      │              │    │
│  │              │      │ 룸메이트:     │    │
│  │ 🚪 하루 1회...│     │ "안녕하세요!  │    │
│  │ 💬 AI 이웃...│      │  처음 뵙네요. │    │
│  │ ❤️ 관계 구축 │      │  저는 당신의  │    │
│  │              │      │  첫 룸메이트   │    │
│  │  [다음]      │      │  예요 🏠"     │    │
│  └──────────────┘      │              │    │
│                        │              │    │
│                        └──────────────┘    │
└─────────────────────────────────────────────┘
```

**사용자 액션**:
1. 좌측 팝업 내용 읽기
2. [다음] 버튼 클릭

**버튼 클릭 시**:
- 좌측 팝업 닫힘
- 1초 후 자동으로 다음 메시지 등장

**다음 단계로 이동**: Step 3 (이름 입력)

---

### Step 3: 이름 입력 (ask_name)

**화면 변화**:
```
[우측 채팅창]
┌──────────────────┐
│ 🏠 내 룸메이트     │
├──────────────────┤
│                  │
│ 룸메이트:         │
│ "당신의 이름을    │
│  알려주시겠어요?" │
│                  │
│ ▼ (사용자 입력 대기)|
│                  │
├──────────────────┤
│ [입력창: 이름 입력]│
│ [▶ 전송]         │
└──────────────────┘
```

**사용자 플로우**:
1. 채팅 입력창에 이름 입력
2. Enter 키 또는 ▶ 버튼 클릭
3. 입력한 이름이 말풍선으로 표시됨
   ```
   You: "철수"
   ```
4. 1초 후 자동 응답
   ```
   룸메이트: "반가워요, 철수님! 🎉"
   ```
5. 1초 후 자동으로 다음 단계 진행

**입력 검증**:
- 최소 1자, 최대 20자
- 특수문자 제한 (한글, 영문, 숫자만)
- 빈 값 전송 불가

**에러 처리**:
```
[검증 실패 시]
룸메이트: "이름을 1~20자 이내로 입력해주세요."
→ 재입력 대기
```

---

### Step 4: 나이 입력 (ask_age)

**화면 구성**:
```
[우측 채팅창]
룸메이트: "반가워요, 철수님! 🎉"
           ↓ (1초 후)
룸메이트: "몇 살이신지 여쭤봐도 될까요?"
룸메이트: "(더 나은 대화를 위해 필요해요)"
           ↓
[입력창: 숫자 입력]
```

**사용자 플로우**:
1. 나이 입력 (숫자만)
2. 전송
3. 자동 응답
   ```
   룸메이트: "감사합니다!"
   ```
4. 1초 후 다음 단계

**입력 검증**:
- 숫자만 허용
- 13~99 범위

---

### Step 5: 개인정보 동의 (privacy_policy)

**화면 구성**:
```
┌─────────────────────────────────────────────┐
│  [좌측: 팝업]            [우측: 채팅]        │
│                                             │
│  ┌──────────────┐      룸메이트:           │
│  │ 개인정보     │      "더 나은 대화를      │
│  │ 처리방침     │       위해 일부 정보를   │
│  │──────────────│       사용해도 될까요?"  │
│  │              │                          │
│  │ [스크롤 가능] │                          │
│  │ 1. 수집 정보  │                          │
│  │ 2. 이용 목적  │                          │
│  │ 3. 보유 기간  │                          │
│  │              │                          │
│  ├──────────────┤                          │
│  │ ☐ (필수)     │                          │
│  │   기본 정보   │                          │
│  │   수집 동의   │                          │
│  │              │                          │
│  │ ☐ (선택)     │                          │
│  │   추가 정보   │                          │
│  │   수집        │                          │
│  │              │                          │
│  │  [동의하기]   │                          │
│  └──────────────┘                          │
└─────────────────────────────────────────────┘
```

**사용자 플로우**:
1. 좌측 팝업에서 약관 내용 스크롤하여 읽기
2. (필수) 체크박스 선택
3. (선택) 체크박스 선택 여부 결정
4. [동의하기] 버튼 클릭
   - 필수 체크 안 하면 버튼 비활성
5. 버튼 클릭 시:
   - 채팅에 자동 메시지 추가
     ```
     You: "개인정보 처리방침에 동의했습니다."
     ```
   - 1초 후 응답
     ```
     룸메이트: "감사합니다!"
     ```
   - 팝업 닫힘
   - 1초 후 다음 단계

**API 호출**:
```typescript
// 백그라운드에서 비동기 호출
POST /api/v1/onboarding/privacy-consent
{
  userId,
  requiredConsent: true,
  optionalConsent: [true/false]
}
```

---

### Step 6: 이용약관 동의 (terms)

**화면 구성**: Step 5와 유사
- 좌측 팝업: 이용약관 전문
- 체크박스: 1개 (필수)
- 버튼: [동의 후 계속하기]

**사용자 플로우**:
1. 약관 읽기
2. 체크박스 선택
3. 버튼 클릭
4. 자동 메시지
   ```
   You: "이용약관에 동의했습니다."
   룸메이트: "모든 준비가 끝났어요!"
   ```
5. 1초 후 다음 단계

---

### Step 7: 노크 가이드 (guide)

**화면 구성**:
```
┌─────────────────────────────────────────────┐
│  [좌측: 팝업]            [우측: 채팅]        │
│                                             │
│  ┌──────────────┐      룸메이트:           │
│  │ Knock        │      "지금 바로 노크해   │
│  │ 사용 가이드   │       보세요! 새로운     │
│  │──────────────│       이웃을 만날 수     │
│  │              │       있어요 🚪"         │
│  │ 🚪 하루 1회   │                          │
│  │   노크       │                          │
│  │ - 노크 버튼   │                          │
│  │   클릭       │                          │
│  │              │                          │
│  │ 💬 자유로운   │                          │
│  │   대화       │                          │
│  │ - 방 클릭하여 │                          │
│  │   대화 시작   │                          │
│  │              │                          │
│  │ ❤️ 관계 구축  │                          │
│  │ - 친밀도 상승 │                          │
│  │              │                          │
│  │  [시작하기]   │                          │
│  └──────────────┘                          │
└─────────────────────────────────────────────┘
```

**사용자 플로우**:
1. 가이드 내용 읽기
2. [시작하기] 버튼 클릭
3. 즉시:
   - localStorage에 완료 플래그 저장
   - 팝업 닫힘
   - 온보딩 완료 상태로 전환
   - 하단 노크 버튼 활성화

**완료 후 상태**:
```typescript
// localStorage 저장
localStorage.setItem('knockOnboardingComplete', 'true')

// 상태 업데이트
{
  isOnboarding: false,
  onboardingStep: 'complete',
  userName: "철수",
  userAge: "25",
  hasAgreedPrivacy: true,
  hasAgreedTerms: true
}
```

---

## 정상 플레이 상태 (온보딩 완료 후)

**화면 상태**:
- 1F 방: 공개됨 (룸메이트와 대화 가능)
- 2F~5F 방: 블랙아웃 (노크로 공개 가능)
- 하단: 노크 버튼 활성화 (1회 사용 가능)
- 우측 채팅: 룸메이트와 자유 대화 가능

**가능한 액션**:
1. 노크 버튼 클릭 → 새 이웃 발견
2. 1F 방 클릭 → 룸메이트와 대화
3. 채팅 입력 → 자유 대화

---

## 재방문 사용자 플로우

**시작 상태**:
```typescript
// localStorage 확인
knockOnboardingComplete = 'true'
  ↓
// 온보딩 스킵
{
  isOnboarding: false,
  onboardingStep: 'complete',
  userName: "철수", // 저장된 값 로드 (옵션)
}
  ↓
// 메인 화면 즉시 진입 (정상 상태)
```

**화면**:
- 1F 방 이미 공개됨
- 노크 버튼 바로 사용 가능
- 애니메이션 없음

---

## 플로우 타이밍 요약

| 단계 | 소요 시간 | 누적 시간 |
|------|----------|----------|
| Step 1: 방 밝아지기 | 3.5초 | 3.5초 |
| Step 2: 첫 인사 | ~10초 (읽기 + 클릭) | 13.5초 |
| Step 3: 이름 입력 | ~10초 | 23.5초 |
| Step 4: 나이 입력 | ~5초 | 28.5초 |
| Step 5: 개인정보 동의 | ~20초 (읽기 + 동의) | 48.5초 |
| Step 6: 이용약관 동의 | ~20초 | 68.5초 |
| Step 7: 노크 가이드 | ~10초 | 78.5초 |

**총 예상 소요 시간**: 약 1분 20초 (빠른 사용자 기준)

---

## 이탈 포인트 및 대응

| 이탈 포인트 | 원인 | 대응 방안 |
|-----------|------|----------|
| Step 1 (애니메이션) | 3초 대기 지루함 | 진행 상태 표시 (Loading bar) |
| Step 5 (개인정보) | 약관 길이 | 핵심 요약 상단 표시 |
| Step 6 (이용약관) | 약관 길이 | "빠른 동의" 옵션 제공 고려 |

---

## 버전 이력
- **v2.0** (2025-10-27): 채팅 기반 온보딩 플로우로 전면 개편
- **v1.0** (2025-10-27): 초기 별도 페이지 방식
