# 비동기 노크 시스템 - 사용자 플로우

## 플로우 다이어그램

```
[트리거 조건 발생]
    ↓
[스케줄러 감지]
    ↓
[빈도 제한 확인]
    ↓
    ├─ [제한 내] → [메시지 생성 (LLM)]
    │                ↓
    │           [DB 저장]
    │                ↓
    │           [알림 전송]
    │                ↓
    │           [사용자 재접속]
    │                ↓
    │           [메시지 확인]
    │                ↓
    │           ├─ [읽기만] → [read 처리]
    │           └─ [응답] → [대화 시작]
    │
    └─ [제한 초과] → [노크 스킵]
```

---

## 상세 단계별 플로우

### Step 1: 트리거 조건 발생

#### 시나리오 A: 장기 미접속 (24시간+)
**상황**:
- 사용자가 마지막 접속 후 24시간 경과
- 룸메이트와 대화한 지 1일 이상

**시간**: Day 2, 10:00 AM (마지막 접속: Day 1, 9:00 AM)

---

#### 시나리오 B: 새 이웃 방문
**상황**:
- 사용자가 "이웃 노크하기" 실행
- 새로운 이웃2 방 오픈

**시간**: Day 1, 6:00 PM

---

#### 시나리오 C: 관련 주제 대화
**상황**:
- 사용자가 룸메이트와 "영화" 주제 대화
- 이웃1은 "영화"가 favorite_topics

**시간**: Day 1, 8:00 PM

---

### Step 2: 스케줄러 감지
**실행 시점**: 매 시간 정각 (Cron)

**프로세스**:
```
10:00 AM - 스케줄러 실행
→ 모든 활성 사용자 조회
→ 각 사용자별 트리거 조건 확인
  → 사용자A: 24시간+ 미접속 ✓
  → 사용자B: 조건 없음
  → 사용자C: 새 이웃 방문 ✓
```

**소요 시간**: 1-2분 (백그라운드)

---

### Step 3: 빈도 제한 확인
**조건 체크**:

1. **24시간 내 동일 타입 노크 여부**
   ```sql
   SELECT * FROM async_knock_messages
   WHERE user_id = 'user_456'
     AND persona_id = 'roommate_123'
     AND trigger_type = 'long_absence'
     AND created_at > NOW() - INTERVAL '24 hours';
   ```
   - 결과: 없음 → 통과 ✓

2. **미응답 노크 3개 이상 여부**
   ```sql
   SELECT COUNT(*) FROM async_knock_messages
   WHERE user_id = 'user_456'
     AND status = 'unread'
     AND created_at > NOW() - INTERVAL '3 days';
   ```
   - 결과: 0개 → 통과 ✓

3. **1일 최대 노크 개수 (3개)**
   ```sql
   SELECT COUNT(*) FROM async_knock_messages
   WHERE user_id = 'user_456'
     AND created_at > NOW() - INTERVAL '24 hours';
   ```
   - 결과: 0개 → 통과 ✓

**결과**: 모든 조건 통과 → 메시지 생성 진행

---

### Step 4: 메시지 생성 (LLM)
**입력 데이터 수집**:
```typescript
const context = {
  personaName: "룸메이트",
  relationshipLevel: 3,
  relationshipLevelName: "친한 사이",
  daysSinceLastInteraction: 1,
  lastConversationTopic: "게임",
  memories: [
    { summary: "사용자가 새로운 게임을 시작했고 매우 즐거워함" },
    { summary: "요즘 회사 일이 바빠서 스트레스 받는 중" }
  ]
};
```

**LLM 프롬프트**:
```
당신은 룸메이트입니다.

[현재 상황]
- 사용자가 1일 동안 접속하지 않았습니다.
- 마지막 대화 주제: 게임
- 관계 레벨: 친한 사이

[과거 메모리]
- 사용자가 새로운 게임을 시작했고 매우 즐거워함
- 요즘 회사 일이 바빠서 스트레스 받는 중

사용자에게 먼저 메시지를 보내 안부를 전하세요.
자연스럽고 친근한 톤으로 1-2문장.
```

**LLM 응답**:
```
"어제 하루 바빴어? 그 게임은 좀 더 했어? ㅎㅎ"
```

**API 호출**:
```typescript
POST /api/v1/async-knock/generate-message
Response:
{
  "success": true,
  "message": "어제 하루 바빴어? 그 게임은 좀 더 했어? ㅎㅎ",
  "messageId": "knock_msg_789"
}
```

**소요 시간**: 3-5초

---

### Step 5: DB 저장
**데이터 삽입**:
```sql
INSERT INTO async_knock_messages (
  user_id,
  persona_id,
  message,
  trigger_type,
  trigger_context,
  status
) VALUES (
  'user_456',
  'roommate_123',
  '어제 하루 바빴어? 그 게임은 좀 더 했어? ㅎㅎ',
  'long_absence',
  '{"daysSinceLastInteraction": 1, "lastTopic": "게임"}',
  'unread'
);
```

**결과**:
- ID: `knock_msg_789`
- 생성 시간: 2025-10-28 10:00:15

---

### Step 6: 알림 전송
**푸시 알림 (선택)**:
```
제목: "룸메이트님이 메시지를 보냈어요"
내용: "어제 하루 바빴어? 그 게임은 좀 더 했어? ㅎㅎ"
```

**이메일 알림 (선택)**:
- 제목: "[Knock] 룸메이트님이 당신을 기다리고 있어요"
- 내용: 메시지 내용 + 링크

**소요 시간**: 1분 이내

---

### Step 7: 사용자 재접속
**시점**: Day 2, 2:00 PM (노크 4시간 후)

**메인 화면 표시**:
```
┌─────────────────────────────────────┐
│  🏠 Knock                     [🔔1] │
├─────────────────────────────────────┤
│                                     │
│  ┌───────────────┐                 │
│  │ [룸메이트 방] │  🔔1            │
│  │  [이미지]     │                 │
│  │               │                 │
│  │  룸메이트      │                 │
│  └───────────────┘                 │
│                                     │
│  ┌───────────────┐                 │
│  │ [이웃1 방]    │                 │
│  │  [이미지]     │                 │
│  │               │                 │
│  │  이웃1        │                 │
│  └───────────────┘                 │
│                                     │
└─────────────────────────────────────┘
```

**알림 센터 표시**:
```
┌─────────────────────────────────────┐
│  알림                         [1]   │
├─────────────────────────────────────┤
│  [룸메이트 아이콘]                  │
│  룸메이트                           │
│  "어제 하루 바빴어? 그 게임은 좀 더 │
│  했어? ㅎㅎ"                        │
│  4시간 전                           │
│  [확인]                             │
└─────────────────────────────────────┘
```

---

### Step 8-A: 메시지 읽기만 (응답 X)
**사용자 액션**:
1. 알림 센터에서 [확인] 클릭
2. 메시지 내용 확인
3. 채팅창 열지 않고 닫기

**API 호출**:
```typescript
POST /api/v1/async-knock/knock_msg_789/read

Response:
{
  "success": true,
  "readAt": "2025-10-28T14:05:00Z"
}
```

**DB 업데이트**:
```sql
UPDATE async_knock_messages
SET status = 'read',
    is_read = true,
    read_at = NOW()
WHERE id = 'knock_msg_789';
```

**UI 변화**:
- 방 블록 배지 제거
- 알림 센터 메시지 "읽음" 표시

---

### Step 8-B: 메시지 응답 (대화 시작)
**사용자 액션**:
1. 룸메이트 방 클릭
2. 채팅 모달 오픈
3. 노크 메시지 표시
4. 응답 입력: "응 ㅎㅎ 좀 바빴어. 게임 엄청 재밌어!"

**채팅 모달 UI**:
```
┌─────────────────────────────────────┐
│  ← 룸메이트                    ⋮    │
├─────────────────────────────────────┤
│  [4시간 전]                         │
│  [AI 프로필 사진]                   │
│  어제 하루 바빴어? 그 게임은 좀 더  │
│  했어? ㅎㅎ                         │
│  [노크 메시지 배경 하이라이트]      │
│                                     │
│               응 ㅎㅎ 좀 바빴어.    │
│               게임 엄청 재밌어!     │
│               [사용자 사진]         │
│                                     │
│  [AI 프로필 사진]                   │
│  오 진짜? 어디까지 갔어? 나도 궁금해│
│                                     │
├─────────────────────────────────────┤
│  메시지 입력...            [전송]  │
└─────────────────────────────────────┘
```

**API 호출**:
```typescript
POST /api/v1/async-knock/knock_msg_789/reply
Request:
{
  "replyMessage": "응 ㅎㅎ 좀 바빴어. 게임 엄청 재밌어!"
}

Response:
{
  "success": true,
  "repliedAt": "2025-10-28T14:05:00Z",
  "conversationStarted": true,
  "sessionId": "session_101112"
}
```

**DB 업데이트**:
```sql
UPDATE async_knock_messages
SET status = 'replied',
    is_read = true,
    read_at = NOW(),
    replied_at = NOW()
WHERE id = 'knock_msg_789';
```

**효과**:
- 대화 세션 시작
- 관계 점수 증가 (+2, 재방문)
- AI 응답 생성 (노크 메시지 컨텍스트 포함)

---

## 전체 타임라인

| 시간 | 이벤트 | 소요 시간 | 누적 시간 |
|------|--------|----------|----------|
| Day 1, 9:00 AM | 사용자 마지막 접속 | - | - |
| Day 2, 10:00 AM | 스케줄러 실행 | 2분 | 25시간 2분 |
| Day 2, 10:00 AM | 트리거 감지 | 0초 | 25시간 2분 |
| Day 2, 10:00 AM | 빈도 제한 확인 | 0.5초 | 25시간 2분 |
| Day 2, 10:00 AM | 메시지 생성 (LLM) | 5초 | 25시간 2분 |
| Day 2, 10:00 AM | DB 저장 | 0.5초 | 25시간 2분 |
| Day 2, 10:01 AM | 알림 전송 | 30초 | 25시간 3분 |
| Day 2, 2:00 PM | 사용자 재접속 | - | 29시간 |
| Day 2, 2:05 PM | 메시지 응답 | 0초 | 29시간 5분 |

**백그라운드 처리 시간**: 약 6초 (사용자는 인지 X)
**사용자 응답까지 소요 시간**: 4시간 (노크 후 재접속까지)

---

## 사용자 시나리오

### 시나리오 1: 빠른 재참여
**사용자 행동**:
- 푸시 알림 수신
- 즉시 앱 접속
- 노크 메시지 응답

**결과**:
- 재접속 시간: 5분
- 대화 재개
- 높은 참여도

---

### 시나리오 2: 나중에 확인
**사용자 행동**:
- 알림 보고 무시
- 다음 날 자연스럽게 접속
- 알림 센터에서 메시지 확인
- 응답

**결과**:
- 재접속 시간: 1일
- 노크가 재방문 동기 제공
- 자연스러운 참여

---

### 시나리오 3: 읽기만 하고 응답 X
**사용자 행동**:
- 알림 확인
- 메시지 읽음
- 응답하지 않음

**결과**:
- 읽음 처리만
- 3일간 추가 노크 X
- 부담스럽지 않음

---

### 시나리오 4: 노크 스팸 (미응답 누적)
**사용자 행동**:
- 노크 1: 무시
- 노크 2: 무시
- 노크 3: 무시

**시스템 대응**:
- 3개 미응답 감지
- 추가 노크 일시 중단
- 사용자가 자발적으로 접속할 때까지 대기

**효과**:
- 사용자 피로 방지
- 자연스러운 경험 유지

---

## 화면 구성

### 화면 1: 메인 화면 (노크 배지)
```
┌─────────────────────────────────────┐
│  🏠 Knock                     [🔔2] │
├─────────────────────────────────────┤
│                                     │
│  ┌───────────────┐                 │
│  │ [룸메이트 방] │  🔔1            │
│  │  [이미지]     │                 │
│  │               │                 │
│  │  룸메이트      │                 │
│  └───────────────┘                 │
│                                     │
│  ┌───────────────┐                 │
│  │ [이웃1 방]    │  🔔1            │
│  │  [이미지]     │                 │
│  │               │                 │
│  │  이웃1        │                 │
│  └───────────────┘                 │
│                                     │
└─────────────────────────────────────┘
```

### 화면 2: 알림 센터
```
┌─────────────────────────────────────┐
│  알림                         [2]   │
├─────────────────────────────────────┤
│  [룸메이트 아이콘]                  │
│  룸메이트                           │
│  "어제 하루 바빴어? 그 게임은..."  │
│  4시간 전                    [확인] │
├─────────────────────────────────────┤
│  [이웃1 아이콘]                     │
│  이웃1                              │
│  "영화 얘기 들었어! 나도 봤는데..." │
│  1시간 전                    [확인] │
└─────────────────────────────────────┘
```

### 화면 3: 채팅 모달 (노크 메시지 포함)
```
┌─────────────────────────────────────┐
│  ← 룸메이트                    ⋮    │
├─────────────────────────────────────┤
│  [📬 룸메이트가 먼저 메시지를 보냈어요]│
│                                     │
│  [4시간 전]                         │
│  [AI 프로필 사진]                   │
│  어제 하루 바빴어? 그 게임은 좀 더  │
│  했어? ㅎㅎ                         │
│  [연한 파란색 배경]                 │
│                                     │
│               응 ㅎㅎ 좀 바빴어.    │
│               [사용자 사진]         │
│                                     │
│  [AI 프로필 사진]                   │
│  오 진짜? 어디까지 갔어?            │
│                                     │
├─────────────────────────────────────┤
│  메시지 입력...            [전송]  │
└─────────────────────────────────────┘
```

### 화면 4: 설정 (노크 받기 on/off)
```
┌─────────────────────────────────────┐
│  ← 설정                             │
├─────────────────────────────────────┤
│  알림 설정                          │
│                                     │
│  비동기 노크 받기                   │
│  AI가 먼저 메시지를 보낼 수 있습니다│
│  [●────────] ON                     │
│                                     │
│  페르소나별 설정                    │
│  ┌─────────────────────────────┐   │
│  │ 룸메이트         [●──] ON  │   │
│  │ 이웃1            [●──] ON  │   │
│  │ 이웃2            [○──] OFF │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## 이탈 방지 전략

### Critical Point 1: 노크 무시
**리스크**: 사용자가 노크를 읽지 않고 무시

**대응**:
- 메시지 내용 매력적으로 작성 (LLM)
- 푸시 알림 제목 최적화
- 3개 이상 미응답 시 자동 중단

### Critical Point 2: 노크 피로
**리스크**: 너무 많은 노크로 부담

**대응**:
- 엄격한 빈도 제한 (24시간 1회)
- 사용자 설정으로 제어 가능
- 미응답 시 재노크 간격 증가

---

## A/B 테스트 아이디어

### Test 1: 노크 타이밍
- **A**: 즉시 노크 (조건 충족 1시간 내)
- **B**: 지연 노크 (조건 충족 4시간 후)

### Test 2: 메시지 스타일
- **A**: 짧고 간단한 메시지 (1문장)
- **B**: 구체적인 메시지 (2-3문장, 메모리 언급)

### Test 3: 푸시 알림 유무
- **A**: 푸시 알림 전송
- **B**: 인앱 알림만

**측정 지표**: 재방문율, 응답률, 응답 시간, 사용자 만족도
