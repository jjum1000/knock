# 대화 시스템 - 사용자 플로우

## 플로우 다이어그램

```
[메인 화면]
    ↓
[방 블록 클릭]
    ↓
[채팅 모달 오픈]
    ↓
[채팅 세션 생성 (백엔드)]
    ↓
    ├─ [첫 대화] → [AI 첫 인사말 표시]
    │                ↓
    │             [사용자 메시지 입력]
    │
    └─ [재방문] → [이전 세션 복원 (선택)]
                    ↓
                 [사용자 메시지 입력]
    ↓
[메시지 전송]
    ↓
[타이핑 인디케이터 표시]
    ↓
[LLM 응답 대기 (2-3초)]
    ↓
[AI 응답 표시]
    ↓
    ├─ [대화 계속] → [메시지 입력]
    │
    └─ [모달 닫기] → [세션 종료]
                        ↓
                     [메인 화면 복귀]
```

---

## 상세 단계별 플로우

### Step 1: 메인 화면 - 방 블록
**화면 구성**: 룸메이트 방 + 이웃 방들

**방 블록 상태**:
- 기본: 방 이미지
- 호버: 경계선 하이라이트 + 키워드 툴팁
- 읽지 않은 메시지 (선택 기능): 💬 뱃지

**사용자 액션**:
- 방 블록 클릭 → Step 2

**소요 시간**: 0초

---

### Step 2: 채팅 모달 오픈
**화면 전환**: 전체 화면 모달 (모바일) / 중앙 모달 (데스크톱)

**로딩 과정**:
1. 모달 페이드 인 (0.3초)
2. 채팅 세션 생성 API 호출 (0.2초)
3. 채팅 영역 렌더링

**화면 구성**:
```
┌─────────────────────────────────────┐
│  ← 룸메이트         #게임매니아 ⓘ   │
├─────────────────────────────────────┤
│                                     │
│   [로딩 중...]                      │
│                                     │
├─────────────────────────────────────┤
│  [메시지 입력...]          [전송]   │
└─────────────────────────────────────┘
```

**API 호출**:
```javascript
POST /api/v1/chat/session
{
  "userId": "user_123",
  "personaId": "persona_456"
}

// Response (0.2초 후)
{
  "success": true,
  "sessionId": "session_789",
  "persona": {
    "id": "persona_456",
    "name": "룸메이트",
    "keywords": ["게임매니아", "영화평론가"]
  },
  "initialMessage": "어, 왔어? 오늘 하루 어땠어?"
}
```

**소요 시간**: 0.5초

---

### Step 3: 첫 인사말 표시 (첫 대화만)
**조건**: 해당 페르소나와 첫 대화 또는 세션 신규 생성

**화면 구성**:
```
┌─────────────────────────────────────┐
│  ← 룸메이트         #게임매니아 ⓘ   │
├─────────────────────────────────────┤
│                                     │
│   [AI] 어, 왔어? 오늘 하루 어땠어?  │
│        12:00                        │
│                                     │
│                                     │
│                                     │
│                                     │
├─────────────────────────────────────┤
│  [메시지 입력...]          [전송]   │
└─────────────────────────────────────┘
```

**화면 요소**:
- AI 첫 인사말 (페르소나별 사전 생성 또는 LLM 생성)
- 타임스탬프 (현재 시간)
- 입력 필드 자동 포커스 (모바일 키보드 오픈)

**사용자 액션**:
- 메시지 입력 필드 클릭 → Step 4

**소요 시간**: 2-5초 (읽기 시간)

---

### Step 4: 사용자 메시지 입력
**입력 필드 상태**:
- 포커스 시: 테두리 하이라이트
- 입력 중: 글자 수 표시 (선택, 예: 500자 제한)
- Enter 키: 전송
- Shift+Enter: 줄바꿈

**화면 구성**:
```
┌─────────────────────────────────────┐
│  ← 룸메이트         #게임매니아 ⓘ   │
├─────────────────────────────────────┤
│                                     │
│   [AI] 어, 왔어? 오늘 하루 어땠어?  │
│        12:00                        │
│                                     │
│                                     │
│                                     │
│                                     │
├─────────────────────────────────────┤
│  [안녕! 잘 지냈어? 요즘...]  [전송] │
│                           ↑ 포커스  │
└─────────────────────────────────────┘
```

**사용자 액션**:
- [전송] 버튼 클릭 → Step 5
- Enter 키 → Step 5
- 모달 닫기 → Step 9

**소요 시간**: 5-15초 (타이핑)

---

### Step 5: 메시지 전송
**프로세스**:
1. 입력 필드 비활성화 (중복 전송 방지)
2. 사용자 메시지 즉시 화면 표시
3. API 호출 (백엔드 → LLM)
4. 타이핑 인디케이터 표시
5. 스크롤 자동 하단 이동

**화면 구성** (전송 직후):
```
┌─────────────────────────────────────┐
│  ← 룸메이트         #게임매니아 ⓘ   │
├─────────────────────────────────────┤
│                                     │
│   [AI] 어, 왔어? 오늘 하루 어땠어?  │
│        12:00                        │
│                                     │
│          안녕! 잘 지냈어? [User]    │
│                         12:01       │
│                                     │
│   [타이핑 중...]                    │
│   • • •                             │
│                                     │
├─────────────────────────────────────┤
│  [메시지 입력...]          [전송]   │
│  (비활성화)                          │
└─────────────────────────────────────┘
```

**API 호출**:
```javascript
POST /api/v1/chat/message
{
  "sessionId": "session_789",
  "userId": "user_123",
  "personaId": "persona_456",
  "message": "안녕! 잘 지냈어?"
}

// 백엔드에서 LLM 호출 (2-3초)
```

**소요 시간**: 0.1초 (화면 업데이트만)

---

### Step 6: LLM 응답 대기
**타이핑 인디케이터**: 애니메이션 점 3개 (• • •)

**백엔드 프로세스**:
1. 시스템 프롬프트 조회
2. 세션 대화 히스토리 조회 (최근 10개)
3. Gemini API 호출
4. 응답 생성
5. 세션에 메시지 저장

**예상 시간**: 2-3초 (평균)

**타임아웃**: 5초 (초과 시 Fallback 응답)

---

### Step 7: AI 응답 표시
**화면 구성**:
```
┌─────────────────────────────────────┐
│  ← 룸메이트         #게임매니아 ⓘ   │
├─────────────────────────────────────┤
│                                     │
│   [AI] 어, 왔어? 오늘 하루 어땠어?  │
│        12:00                        │
│                                     │
│          안녕! 잘 지냈어? [User]    │
│                         12:01       │
│                                     │
│   [AI] 오 반가워! 요즘 뭐하고 지내? │
│        나는 새로운 게임 발견했는데  │
│        진짜 재밌더라!               │
│        12:01                        │
│                                     │
├─────────────────────────────────────┤
│  [메시지 입력...]          [전송]   │
│  (활성화)                            │
└─────────────────────────────────────┘
```

**애니메이션**:
- 타이핑 인디케이터 페이드 아웃
- AI 메시지 페이드 인 (0.3초)
- 스크롤 자동 하단 이동

**입력 필드 재활성화**: 즉시 다음 메시지 입력 가능

**사용자 액션**:
- 다음 메시지 입력 → Step 4 (대화 계속)
- 모달 닫기 → Step 9

**소요 시간**: 0.3초 (애니메이션)

---

### Step 8: 대화 계속 (반복)
**플로우**: Step 4 → Step 5 → Step 6 → Step 7 → Step 4 ...

**대화 예시**:
```
User: 안녕! 잘 지냈어?
AI: 오 반가워! 요즘 뭐하고 지내? 나는 새로운 게임 발견했는데 진짜 재밌더라!

User: 오 어떤 게임인데?
AI: 인디 게임인데, 퍼즐이랑 스토리가 기가 막혀. 너도 좋아할 것 같은데?

User: 제목이 뭐야?
AI: "The Witness"라고 있어. 해봤어?
```

**세션 메모리**: 최근 10개 메시지 컨텍스트 유지

**평균 대화 길이**: 5-10회 왕복

---

### Step 9: 모달 닫기
**트리거**:
- [←] 닫기 버튼 클릭
- 모달 외부 클릭 (데스크톱)
- 뒤로 가기 (모바일)

**프로세스**:
1. 모달 페이드 아웃 (0.3초)
2. 세션 종료 API 호출 (선택)
3. Redis 세션 자동 만료 (1시간 TTL)

**영구 메모리 (유료 기능)**:
- 대화 요약 LLM 생성
- DB에 영구 저장

**화면 전환**: 메인 화면 복귀

**소요 시간**: 0.3초

---

## 전체 타임라인

| Step | 화면 | 평균 소요 시간 | 누적 시간 |
|------|------|----------------|-----------|
| 1 | 메인 화면 | 0초 | 0초 |
| 2 | 모달 오픈 | 0.5초 | 0.5초 |
| 3 | 첫 인사말 | 3초 | 3.5초 |
| 4 | 메시지 입력 | 10초 | 13.5초 |
| 5 | 메시지 전송 | 0.1초 | 13.6초 |
| 6 | LLM 응답 대기 | 2.5초 | 16.1초 |
| 7 | AI 응답 표시 | 0.3초 | 16.4초 |
| 8 | 대화 계속 (5회 왕복) | 5분 | - |
| 9 | 모달 닫기 | 0.3초 | - |

**첫 대화 시작 → 첫 응답**: 약 16초
**평균 대화 세션**: 5-10분

---

## 화면 구성

### 주요 화면 목록
1. **메인 화면** - 방 블록들
2. **채팅 모달** - 헤더 + 채팅 영역 + 입력 영역
3. **프로필 모달** - 페르소나 상세 정보 (ⓘ 클릭)

### 채팅 모달 레이아웃
```
┌─────────────────────────────────────┐
│  [헤더]                              │  ← 고정
│  - 닫기 버튼                         │
│  - AI 이름                           │
│  - 키워드 1개                        │
│  - 프로필 버튼                       │
├─────────────────────────────────────┤
│  [채팅 영역]                         │  ← 스크롤 가능
│  - AI 메시지 (좌측 정렬)            │
│  - User 메시지 (우측 정렬)          │
│  - 타이핑 인디케이터                │
│  - 자동 스크롤 하단                 │
│                                     │
│                                     │
│                                     │
├─────────────────────────────────────┤
│  [입력 영역]                         │  ← 고정
│  - 텍스트 입력 필드                 │
│  - 전송 버튼                         │
└─────────────────────────────────────┘
```

---

## 사용자 액션

### 필수 액션 (MVP)
1. **방 블록 클릭** → 채팅 모달 오픈
2. **메시지 입력** → AI 응답 수신
3. **대화 계속** → 여러 번 왕복
4. **모달 닫기** → 세션 종료

### 선택 액션 (Enhancement)
5. **프로필 보기** → 페르소나 상세 정보
6. **읽지 않은 메시지** → 비동기 노크 확인 (유료)

---

## 인터랙션 상세

### 1. 메시지 말풍선 스타일
**AI 메시지**:
- 배경: 연한 회색 (#f0f0f0)
- 정렬: 좌측
- 테두리: 둥근 모서리 (12px)
- 최대 너비: 70%

**사용자 메시지**:
- 배경: 그라데이션 (보라 → 퍼플)
- 정렬: 우측
- 색상: 흰색 텍스트
- 최대 너비: 70%

### 2. 타이핑 인디케이터
**애니메이션**:
- 3개의 점 (• • •)
- 순차적으로 위아래로 움직임
- 반복 애니메이션 (1.4초 주기)

**위치**: AI 메시지 영역 (좌측 정렬)

### 3. 자동 스크롤
**트리거**:
- 새 메시지 추가 시
- AI 응답 수신 시

**동작**:
```javascript
function scrollToBottom() {
  const chatArea = document.querySelector('.chat-area');
  chatArea.scrollTo({
    top: chatArea.scrollHeight,
    behavior: 'smooth'
  });
}
```

**예외**: 사용자가 스크롤 중이면 자동 스크롤 비활성화

### 4. Enter 키 전송
**키보드 이벤트**:
```javascript
inputField.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
  // Shift+Enter는 줄바꿈 (기본 동작)
});
```

### 5. 모바일 키보드 대응
**자동 포커스**:
```javascript
// 모달 오픈 시 입력 필드 자동 포커스
modal.addEventListener('shown', () => {
  inputField.focus();
});
```

**키보드 오픈 시 스크롤 조정**:
```javascript
// 키보드가 입력 필드를 가리지 않도록
window.addEventListener('resize', () => {
  if (isKeyboardOpen()) {
    scrollToBottom();
  }
});
```

---

## 이탈 방지 전략

### Critical Point 1: Step 3 (첫 인사말)
**리스크**: AI 첫 인사가 매력적이지 않음

**대응**:
- 페르소나별 매력적인 첫 인사 생성 (LLM 최적화)
- 질문 포함하여 대화 유도
- 이모지 적절히 사용

### Critical Point 2: Step 6 (LLM 대기)
**리스크**: 3초 대기 시간에 이탈

**대응**:
- 타이핑 인디케이터로 "생각 중" 인지
- 최대 5초 타임아웃
- 응답 속도 최적화 (캐싱, 병렬 처리)

### Critical Point 3: Step 7 (AI 응답 품질)
**리스크**: AI 응답이 기대에 못 미침

**대응**:
- 시스템 프롬프트 품질 검증
- 대화 흐름 자연스럽게 유지
- 질문으로 대화 이어가기

---

## A/B 테스트 아이디어

### Test 1: 첫 인사말 스타일
- **A**: 질문형 ("어, 왔어? 오늘 하루 어땠어?")
- **B**: 정보 전달형 ("어, 왔어! 나 오늘 재밌는 일 있었어")

### Test 2: 타이핑 인디케이터
- **A**: 점 3개 애니메이션 (• • •)
- **B**: "생각 중..." 텍스트 + 스피너

### Test 3: 메시지 말풍선 스타일
- **A**: 심플 (단색 배경)
- **B**: 그라데이션 + 그림자

**측정 지표**:
- 평균 대화 세션 길이
- 메시지당 평균 응답 시간 (사용자 체감)
- 대화 재시작률
- 사용자 만족도 (설문)
