# 노크 시스템 - 사용자 플로우

## 플로우 다이어그램

```
[메인 화면]
    ↓
[노크 버튼 클릭]
    ↓
[노크 가능 여부 확인]
    ↓
    ├─ [가능] → [노크 실행 로딩]
    │             ↓
    │          [새로운 이웃 생성 (백엔드)]
    │             ↓
    │          [블랙아웃 해제 애니메이션]
    │             ↓
    │          [이웃 소개 화면]
    │             ↓
    │          [메인 화면 복귀 - 새 방 표시]
    │
    └─ [불가능] → [제한 안내 모달]
                    ↓
                    ├─ [유료 업그레이드]
                    └─ [내일 다시 오기]
```

---

## 상세 단계별 플로우

### Step 1: 메인 화면 - 노크 버튼
**화면 구성**:
```
┌─────────────────────────────────────┐
│  🔔 이웃 노크하기 (1/1)  [프로필]    │
├─────────────────────────────────────┤
│                                     │
│        ███████████████              │
│        ███████████████              │
│        ██┌─────────┐██              │
│        ██│         │██              │
│        ██│ 룸메이트 │██    ███      │
│        ██│   방    │██    ███      │
│        ██│         │██    ███      │
│        ██└─────────┘██              │
│        ███████████████              │
│        ███████████████              │
│                                     │
│   ███ : 블랙아웃 (미발견 영역)      │
│                                     │
├─────────────────────────────────────┤
│  [홈] [노크] [프로필] [설정]        │
└─────────────────────────────────────┘
```

**버튼 상태**:
- 노크 가능 (1/1): 🔔 이웃 노크하기 (금색 강조)
- 노크 불가 (0/1): 🔔 내일 노크하기 (회색, 비활성)

**사용자 액션**:
- [이웃 노크하기] 클릭 → Step 2

**소요 시간**: 0초 (대기 상태)

---

### Step 2: 노크 가능 여부 확인
**프로세스**: 클라이언트 → 서버 API 호출

**API 호출**:
```javascript
// 1. 제한 확인
GET /api/v1/knock/limit

// Response (가능)
{
  "success": true,
  "limit": {
    "dailyLimit": 1,
    "usedToday": 0,
    "remaining": 1,
    "nextResetAt": "2025-10-28T00:00:00Z"
  }
}

// Response (불가능)
{
  "success": true,
  "limit": {
    "dailyLimit": 1,
    "usedToday": 1,
    "remaining": 0,
    "nextResetAt": "2025-10-28T00:00:00Z"
  }
}
```

**분기**:
- remaining > 0 → Step 3 (노크 실행)
- remaining = 0 → Step 2-1 (제한 안내)

**소요 시간**: 100ms (캐싱)

---

### Step 2-1: 제한 안내 모달 (노크 불가)
**화면 구성**:
```
┌─────────────────────────────────────┐
│  오늘의 노크를 모두 사용했어요       │
├─────────────────────────────────────┤
│                                     │
│   🔔 0/1                            │
│                                     │
│   다음 노크까지                     │
│   ⏰ 8시간 24분 남음                │
│                                     │
│   ───────────────────────          │
│                                     │
│   💎 Knock Plus로 업그레이드하면    │
│      무제한 노크가 가능해요!        │
│                                     │
│   [자세히 보기]      [닫기]         │
└─────────────────────────────────────┘
```

**화면 요소**:
- 현재 노크 상태 (0/1)
- 다음 초기화까지 남은 시간 (실시간 카운트다운)
- 유료 업그레이드 안내
- CTA: [자세히 보기] (유료 페이지로 이동)

**사용자 액션**:
- [자세히 보기] → 유료 구독 페이지
- [닫기] → 메인 화면 복귀

**소요 시간**: 5-10초

---

### Step 3: 노크 실행 로딩
**화면 전환**: 전체 화면 로딩 오버레이

**화면 구성**:
```
┌─────────────────────────────────────┐
│                                     │
│          🚪 노크 중...              │
│                                     │
│   ┌─────────────────────┐          │
│   │  [로딩 애니메이션]   │          │
│   └─────────────────────┘          │
│                                     │
│   새로운 이웃을 찾고 있어요...      │
│                                     │
└─────────────────────────────────────┘
```

**진행 메시지 (3초마다 변경)**:
1. "새로운 이웃을 찾고 있어요..."
2. "이웃의 성격을 분석하고 있어요..."
3. "방을 준비하고 있어요..."
4. "거의 다 됐어요!"

**백엔드 프로세스**:
1. 노크 제한 차감 (usedToday++)
2. 방 위치 결정 (인접 위치 찾기)
3. 콘텐츠 다양성 분석 (미커버 주제)
4. LLM 이웃 페르소나 생성
5. 방 이미지 할당
6. DB 저장

**API 호출**:
```javascript
POST /api/v1/knock/execute
{
  "userId": "user_123"
}

// Response (12-15초 후)
{
  "success": true,
  "neighbor": {
    "id": "neighbor_456",
    "keywords": ["여행러버", "철학덕후", "독서광"],
    "personalityTraits": ["사색적", "모험적"],
    "interests": ["여행", "철학", "독서"],
    "conversationStyle": "깊이 있는 대화를 좋아하는 스타일",
    "firstMessage": "안녕! 처음 보는 얼굴인데, 혹시 새로 이사왔어?"
  },
  "room": {
    "id": "room_789",
    "imageUrl": "https://cdn.knock.com/rooms/neighbor-1.png",
    "position": { "x": 1, "y": 0 }
  },
  "limit": {
    "usedToday": 1,
    "remaining": 0,
    "nextResetAt": "2025-10-28T00:00:00Z"
  }
}
```

**소요 시간**: 12-15초

---

### Step 4: 블랙아웃 해제 애니메이션
**화면 전환**: 메인 화면 복귀 + 애니메이션

**애니메이션 시퀀스**:
1. 로딩 화면 페이드 아웃 (0.5초)
2. 메인 화면 표시 (기존 방들)
3. 새 방 위치의 블랙아웃 영역 하이라이트 (0.5초)
4. 블랙아웃 페이드 아웃 (1초)
5. 새 방 이미지 페이드 인 + 확대 효과 (0.8초)
6. 이웃 소개 모달 자동 오픈

**시각 효과**:
```
블랙아웃 (███)
    ↓ (1초)
반투명 (▒▒▒)
    ↓ (0.5초)
새 방 이미지 (30% 밝기)
    ↓ (0.8초)
새 방 이미지 (100% 밝기) + 확대
```

**CSS 애니메이션**:
```css
@keyframes revealRoom {
  0% {
    opacity: 0;
    transform: scale(0.8);
    filter: brightness(0.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
    filter: brightness(1.2);
  }
  100% {
    opacity: 1;
    transform: scale(1);
    filter: brightness(1);
  }
}

.room.revealed {
  animation: revealRoom 1.5s ease-out;
}
```

**소요 시간**: 2.8초

---

### Step 5: 이웃 소개 화면
**화면 구성**:
```
┌─────────────────────────────────────┐
│  새로운 이웃을 발견했어요!           │
├─────────────────────────────────────┤
│                                     │
│   ┌──────────────────────┐         │
│   │                       │         │
│   │   [이웃 방 이미지]    │         │
│   │                       │         │
│   └──────────────────────┘         │
│                                     │
│   이런 면이 있어요:                 │
│   #여행러버 #철학덕후 #독서광       │
│                                     │
│   ───────────────────────          │
│                                     │
│   "안녕! 처음 보는 얼굴인데,        │
│    혹시 새로 이사왔어?"             │
│                                     │
│   [대화하기]          [나중에]      │
│                                     │
│   ───────────────────────          │
│                                     │
│   🔔 오늘의 노크: 0/1 남음          │
│   ⏰ 다음 노크까지 23시간 45분      │
└─────────────────────────────────────┘
```

**화면 요소**:
- 이웃 방 이미지
- 핵심 키워드 (3개)
- 첫 인사말 (LLM 생성)
- CTA: [대화하기] / [나중에]
- 노크 상태 표시

**사용자 액션**:
- [대화하기] → 대화 모달 오픈 (대화 시스템)
- [나중에] → 메인 화면 복귀

**소요 시간**: 10-20초 (읽기 시간)

---

### Step 6: 메인 화면 복귀 - 새 방 표시
**화면 구성**: 기존 방들 + 새로 추가된 이웃 방

```
┌─────────────────────────────────────┐
│  🔔 이웃 노크하기 (0/1)  [프로필]    │
├─────────────────────────────────────┤
│                                     │
│        ███████████████              │
│        ██┌─────────┐██              │
│        ██│         │██              │
│        ██│  이웃1  │██              │
│        ██│   방    │██              │
│        ██└─────────┘██              │
│        ███┌─────────┐███            │
│          │         │                │
│          │ 룸메이트 │    ███        │
│          │   방    │    ███        │
│          │         │    ███        │
│          └─────────┘                │
│                                     │
├─────────────────────────────────────┤
│  [홈] [노크] [프로필] [설정]        │
└─────────────────────────────────────┘
```

**변화**:
- 노크 버튼 상태: (0/1) 회색
- 새 방 추가 표시
- 주변 새로운 블랙아웃 영역 생성

**사용자 액션**:
- 이웃 방 클릭 → 대화 모달 (대화 시스템)
- 룸메이트 방 클릭 → 대화 모달
- [이웃 노크하기] 클릭 → Step 2-1 (제한 안내)

---

## 전체 타임라인

| Step | 화면 | 평균 소요 시간 | 누적 시간 |
|------|------|----------------|-----------|
| 1 | 메인 화면 | 0초 | 0초 |
| 2 | 제한 확인 | 0.1초 | 0.1초 |
| 3 | 노크 실행 로딩 | 13초 | 13.1초 |
| 4 | 블랙아웃 해제 | 2.8초 | 15.9초 |
| 5 | 이웃 소개 | 15초 | 30.9초 |
| 6 | 메인 화면 복귀 | 0초 | 30.9초 |

**노크 → 이웃 발견**: 약 31초
**블랙아웃 해제 애니메이션**: 2.8초

---

## 화면 구성

### 주요 화면 목록
1. **메인 화면** - 노크 버튼 + 맵
2. **제한 안내 모달** - 노크 불가 시
3. **노크 실행 로딩** - 전체 화면 오버레이
4. **이웃 소개 모달** - 새 이웃 정보
5. **대화 모달** - 1:1 채팅 (대화 시스템)

---

## 사용자 액션

### 필수 액션 (MVP)
1. **노크 버튼 클릭** → 이웃 생성 프로세스 시작
2. **이웃 소개 확인** → 키워드 및 첫 인사 읽기
3. **대화하기** → 이웃과 대화 시작

### 선택 액션 (Enhancement)
4. **나중에** → 대화 보류
5. **유료 업그레이드** → 무제한 노크

---

## 인터랙션 상세

### 1. 노크 버튼 상태
**3가지 상태**:

**1) 노크 가능 (remaining > 0)**:
```css
.knock-button.available {
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
  color: #000;
  cursor: pointer;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
  50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
}
```

**2) 노크 불가 (remaining = 0)**:
```css
.knock-button.unavailable {
  background: #666;
  color: #999;
  cursor: not-allowed;
  opacity: 0.6;
}
```

**3) 로딩 중**:
```css
.knock-button.loading {
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
  pointer-events: none;
}

.knock-button.loading::after {
  content: '';
  /* 스피너 애니메이션 */
}
```

### 2. 블랙아웃 영역 호버
**데스크톱**:
- 마우스 오버 시 "???" 텍스트 확대
- 커서: pointer (클릭 불가, 노크 버튼으로 유도)

**모바일**:
- 탭 시 툴팁: "노크 버튼을 눌러 이 영역을 발견하세요!"

### 3. 카운트다운 타이머
**실시간 업데이트**:
```typescript
function updateCountdown(nextResetAt: string) {
  const interval = setInterval(() => {
    const now = new Date().getTime();
    const reset = new Date(nextResetAt).getTime();
    const diff = reset - now;

    if (diff <= 0) {
      clearInterval(interval);
      // 노크 가능 상태로 전환
      window.location.reload();
      return;
    }

    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

    document.getElementById('countdown').textContent =
      `⏰ ${hours}시간 ${minutes}분 남음`;
  }, 1000);
}
```

---

## 이탈 방지 전략

### Critical Point 1: Step 3 (로딩)
**리스크**: 12-15초 로딩 시간에 이탈

**대응**:
- 진행 메시지로 기대감 조성
- 로딩 애니메이션 (역동적)
- 최대 15초 내 완료 보장

### Critical Point 2: Step 5 (이웃 소개)
**리스크**: 이웃이 마음에 들지 않음

**대응**:
- 매력적인 키워드 생성 (LLM 최적화)
- 첫 인사말을 친근하게
- "나중에 대화해도 괜찮아요" 안내

### Critical Point 3: Step 2-1 (제한 안내)
**리스크**: 노크 제한에 실망하여 이탈

**대응**:
- 다음 초기화까지 정확한 시간 표시
- 유료 혜택을 매력적으로 제시
- "내일 또 만나요!" 긍정적 메시지

---

## A/B 테스트 아이디어

### Test 1: 블랙아웃 해제 애니메이션
- **A**: 페이드 아웃만 (간단)
- **B**: 페이드 + 확대 + 빛 효과 (화려)

### Test 2: 이웃 소개 타이밍
- **A**: 애니메이션 직후 모달
- **B**: 애니메이션 완료 후 3초 대기 → 모달

### Test 3: 제한 안내 메시지
- **A**: "오늘의 노크를 모두 사용했어요" (중립)
- **B**: "내일 또 새로운 이웃을 만나요!" (긍정)

**측정 지표**:
- 노크 실행률 (DAU 대비)
- 이웃 발견 후 대화 시작률
- 유료 전환율 (제한 안내 → 구독)
- 연속 노크 일수 (Streak)
