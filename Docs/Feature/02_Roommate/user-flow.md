# 룸메이트 시스템 - 사용자 플로우

## 플로우 다이어그램

```
[온보딩 완료]
    ↓
[사용자 데이터 LLM 분석]
    ↓
[룸메이트 시스템 프롬프트 생성]
    ↓
[핵심 키워드 추출]
    ↓
[룸메이트 방 생성]
    ↓
[온보딩 완료 화면 - 룸메이트 소개]
    ↓
[메인 화면 - 룸메이트 방 중앙 표시]
    ↓
    ├─ [룸메이트 방 클릭] → [1:1 대화 모달]
    │
    ├─ [룸메이트 프로필 보기] → [키워드/관심사 확인]
    │
    └─ [키워드 수정 (유료)] → [커스터마이징]
```

---

## 상세 단계별 플로우

### Step 1: 룸메이트 생성 (백엔드)
**트리거**: 온보딩 완료 시 자동 실행

**프로세스**:
1. 온보딩에서 수집한 사용자 데이터 조회
2. Gemini LLM API로 데이터 분석
3. 성격, 관심사, 대화 스타일 추출
4. 시스템 프롬프트 자동 생성
5. 핵심 키워드 3-5개 추출
6. DB 저장 (personas 테이블)

**소요 시간**: 10-15초

**API 호출**:
```javascript
POST /api/v1/roommate/create
{
  "userId": "user_123",
  "userDataId": "data_456",
  "preferences": {
    "focusTopics": ["게임", "영화"],
    "avoidTopics": ["정치"]
  }
}

// Response (10-15초 후)
{
  "success": true,
  "roommate": {
    "id": "roommate_789",
    "systemPrompt": "당신은 사용자와 오래 함께 산 룸메이트입니다...",
    "personalityTraits": ["호기심 많음", "유머러스"],
    "interests": ["게임", "영화", "코딩"],
    "conversationStyle": "친근하고 캐주얼",
    "keywords": ["게임매니아", "영화평론가", "코딩덕후"]
  },
  "room": {
    "id": "room_012",
    "imageUrl": "https://cdn.knock.com/rooms/preset-1.png",
    "position": { "x": 0, "y": 0 }
  }
}
```

**예외 처리**:
- LLM 분석 실패 → 재시도 (최대 3회)
- 3회 실패 → 기본 템플릿 사용

---

### Step 2: 온보딩 완료 화면 - 룸메이트 소개
**목표**: 생성된 룸메이트 특성 소개

**화면 구성**:
```
┌─────────────────────────────────────┐
│   당신의 룸메이트를 소개합니다!      │
│                                     │
│   ┌──────────────────────┐         │
│   │                       │         │
│   │   [방 이미지 미리보기] │         │
│   │                       │         │
│   └──────────────────────┘         │
│                                     │
│   이런 면이 있어요:                 │
│   #게임매니아 #영화평론가           │
│   #코딩덕후 #새벽형인간             │
│                                     │
│   ───────────────────────          │
│                                     │
│   "어, 왔어? 오늘 하루 어땠어?      │
│   나는 새로운 게임 하나 발견했는데  │
│   진짜 재밌더라!"                   │
│                                     │
│   [대화 시작하기]                   │
└─────────────────────────────────────┘
```

**화면 요소**:
- 룸메이트 방 이미지 (256x512)
- 핵심 키워드 태그 (3-5개)
- 첫 인사말 (LLM 생성)
- CTA 버튼: [대화 시작하기]

**사용자 액션**:
- [대화 시작하기] 클릭 → Step 3

**소요 시간**: 10-20초 (읽기 시간)

---

### Step 3: 메인 화면 진입
**화면 구성**:
- 룸메이트 방 1개 표시 (맵 중앙, 0,0 위치)
- 주변 영역 블랙아웃
- 상단: "이웃 노크하기" 버튼 (1일 1회)
- 하단: 네비게이션

**화면 레이아웃**:
```
┌─────────────────────────────────────┐
│  [이웃 노크하기] 🔔  [프로필]        │
├─────────────────────────────────────┤
│                                     │
│        ███████████████              │
│        ███████████████              │
│        ██┌─────────┐██              │
│        ██│         │██              │
│        ██│ 룸메이트 │██              │
│        ██│   방    │██              │
│        ██│         │██              │
│        ██└─────────┘██              │
│        ███████████████              │
│        ███████████████              │
│                                     │
├─────────────────────────────────────┤
│  [홈] [노크] [프로필] [설정]        │
└─────────────────────────────────────┘
```

**사용자 액션**:
- 룸메이트 방 클릭 → Step 4 (대화 모달)
- [프로필] 클릭 → Step 5 (룸메이트 프로필)
- [이웃 노크하기] 클릭 → 노크 시스템 (별도 플로우)

---

### Step 4: 룸메이트와 대화
**트리거**: 룸메이트 방 블록 클릭

**화면 전환**: 1:1 채팅 모달 오픈

**모달 구성**:
```
┌─────────────────────────────────────┐
│  ← 룸메이트         #게임매니아 ⓘ   │
├─────────────────────────────────────┤
│                                     │
│   [AI] 어, 왔어? 오늘 하루 어땠어?  │
│        12:00                        │
│                                     │
│                      안녕! [User]   │
│                             12:01   │
│                                     │
│   [AI] 오 반가워! 요즘 뭐하고 지내? │
│        12:01                        │
│                                     │
├─────────────────────────────────────┤
│  [메시지 입력...]          [전송]   │
└─────────────────────────────────────┘
```

**기능**:
- 실시간 LLM 응답 (Gemini API)
- 시스템 프롬프트 적용된 대화
- 세션 기반 메모리 (기본) / 영구 메모리 (선택 기능)

**사용자 액션**:
- 메시지 입력 → LLM 응답 수신
- [ⓘ] 아이콘 클릭 → Step 5 (프로필 상세)
- [←] 닫기 → 메인 화면 복귀

**관련 시스템**: [대화 시스템](../04_Chat/README.md)

---

### Step 5: 룸메이트 프로필 보기
**트리거**:
- 메인 화면 [프로필] 버튼 클릭
- 대화 모달 [ⓘ] 아이콘 클릭

**화면 구성**:
```
┌─────────────────────────────────────┐
│  ← 룸메이트 프로필                   │
├─────────────────────────────────────┤
│                                     │
│   ┌──────────────────────┐         │
│   │   [방 이미지]         │         │
│   └──────────────────────┘         │
│                                     │
│   핵심 키워드                       │
│   #게임매니아 #영화평론가           │
│   #코딩덕후 #새벽형인간             │
│                    [수정] 💎       │
│                                     │
│   관심사                             │
│   게임, 영화, 코딩, 음악            │
│                                     │
│   성격                               │
│   호기심 많음, 유머러스, 열정적     │
│                                     │
│   대화 스타일                       │
│   친근하고 캐주얼하며, 이모지를     │
│   적절히 사용합니다.                │
│                                     │
│   함께한 시간                       │
│   7일 (2025-10-20부터)              │
│                                     │
│   대화 횟수                         │
│   24회                              │
│                                     │
└─────────────────────────────────────┘
```

**화면 요소**:
- 방 이미지
- 핵심 키워드 (수정 가능 - 유료)
- 관심사 목록
- 성격 특성
- 대화 스타일 설명
- 통계 (함께한 시간, 대화 횟수)

**사용자 액션**:
- [수정] 버튼 클릭 → Step 6 (키워드 수정, 유료 전용)
- [←] 닫기 → 이전 화면 복귀

---

### Step 6: 키워드 수정 (유료 전용)
**트리거**: 프로필 화면 [수정] 버튼 클릭

**권한 확인**:
```javascript
const user = getCurrentUser();
if (!user.isPremium) {
  // 유료 안내 모달 표시
  showPremiumModal();
  return;
}
```

**화면 구성** (유료 사용자):
```
┌─────────────────────────────────────┐
│  ← 키워드 수정                       │
├─────────────────────────────────────┤
│                                     │
│   현재 키워드                       │
│   #게임매니아        [X]            │
│   #영화평론가        [X]            │
│   #코딩덕후          [X]            │
│   #새벽형인간        [X]            │
│                                     │
│   ───────────────────────          │
│                                     │
│   [+ 키워드 추가]                   │
│                                     │
│   추천 키워드:                      │
│   #운동매니아 [+]  #요리왕 [+]     │
│   #여행러버 [+]    #책벌레 [+]     │
│                                     │
│   ───────────────────────          │
│                                     │
│   💡 키워드를 수정하면 룸메이트의   │
│      대화 스타일이 바뀔 수 있어요   │
│                                     │
│   [취소]              [저장하기]    │
└─────────────────────────────────────┘
```

**화면 구성** (무료 사용자):
```
┌─────────────────────────────────────┐
│  💎 Knock Plus 전용 기능            │
├─────────────────────────────────────┤
│                                     │
│   키워드 수정 기능은 Knock Plus     │
│   구독자만 사용할 수 있어요          │
│                                     │
│   Knock Plus 혜택:                  │
│   ✓ 룸메이트 키워드 수정            │
│   ✓ 깊은 대화 메모리                │
│   ✓ 이웃 무제한 노크                │
│                                     │
│   [자세히 보기]      [닫기]         │
└─────────────────────────────────────┘
```

**사용자 액션** (유료):
- [X] 버튼 → 키워드 삭제
- [+] 버튼 → 추천 키워드 추가
- [+ 키워드 추가] → 직접 입력 (최대 10개)
- [저장하기] → API 호출 → 프롬프트 업데이트

**API 호출**:
```javascript
PATCH /api/v1/roommate/roommate_789/keywords
{
  "addKeywords": ["운동매니아"],
  "removeKeywords": ["게임매니아"]
}

// Response
{
  "success": true,
  "keywords": ["영화평론가", "코딩덕후", "새벽형인간", "운동매니아"],
  "updatedPrompt": "당신은 사용자와 오래 함께 산 룸메이트입니다..."
}
```

**소요 시간**: 30-60초

---

## 전체 타임라인

| Step | 화면 | 평균 소요 시간 | 누적 시간 |
|------|------|----------------|-----------|
| 1 | 룸메이트 생성 (백엔드) | 12초 | 12초 |
| 2 | 온보딩 완료 - 소개 | 15초 | 27초 |
| 3 | 메인 화면 진입 | 0초 | 27초 |
| 4 | 대화 시작 | 5분+ | - |
| 5 | 프로필 보기 | 20초 | - |
| 6 | 키워드 수정 (유료) | 60초 | - |

**온보딩 → 첫 대화**: 약 30초
**프로필 탐색**: 약 20초
**키워드 수정**: 약 1분

---

## 화면 구성

### 주요 화면 목록
1. **온보딩 완료 화면** - 룸메이트 소개
2. **메인 화면** - 룸메이트 방 중앙 표시
3. **대화 모달** - 1:1 채팅 (대화 시스템)
4. **프로필 화면** - 룸메이트 정보 상세
5. **키워드 수정 화면** - 커스터마이징 (유료)

### 화면 전환 흐름
```
온보딩 완료 → 메인 화면
               ↓
               ├─ 방 클릭 → 대화 모달
               ├─ 프로필 → 프로필 화면
               │             ↓
               │          키워드 수정 (유료)
               └─ 이웃 노크 → 노크 시스템
```

---

## 사용자 액션

### 필수 액션 (MVP)
1. **룸메이트 방 클릭** → 대화 모달 오픈
2. **프로필 보기** → 룸메이트 정보 확인
3. **메시지 전송** → LLM 응답 수신

### 선택 액션 (Enhancement)
4. **키워드 수정** → 프롬프트 커스터마이징 (유료)
5. **관심/금기 주제 설정** → 대화 필터링 (유료)

---

## 인터랙션 상세

### 1. 룸메이트 방 호버 효과
**데스크톱**:
- 마우스 오버 시 방 경계선 하이라이트
- 키워드 미리보기 툴팁 표시

```css
.room-block:hover {
  border: 2px solid #FFD700;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
}

.room-tooltip {
  position: absolute;
  top: -40px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
}
```

**모바일**:
- 탭 시 즉시 대화 모달 오픈
- 롱 프레스 시 프로필 미리보기

### 2. 키워드 태그 인터랙션
**클릭 가능**:
- 키워드 클릭 → 해당 키워드 관련 대화 예시 표시

```
사용자가 #게임매니아 클릭
→ "게임에 대해 이야기해보세요!" 제안
→ 대화 모달에서 자동으로 "요즘 재미있는 게임 있어?" 프롬프트 제안
```

### 3. 프로필 통계 업데이트
**실시간 반영**:
- 대화 후 즉시 "대화 횟수" 증가
- 매일 자정 "함께한 시간" 1일 증가

---

## 이탈 방지 전략

### Critical Point 1: Step 2 (온보딩 완료 화면)
**리스크**: 룸메이트 특성이 마음에 들지 않음

**대응**:
- 키워드를 매력적으로 표현 (LLM 최적화)
- 첫 인사말을 친근하게 생성
- "나중에 수정 가능해요" 안내 문구 (유료 기능)

### Critical Point 2: Step 4 (첫 대화)
**리스크**: 대화 품질이 기대에 못 미침

**대응**:
- 시스템 프롬프트 품질 검증
- 첫 3개 응답은 특히 신경 써서 생성
- 대화가 끊기지 않도록 질문 포함

---

## A/B 테스트 아이디어

### Test 1: 키워드 표시 방식
- **A**: 해시태그 형태 (#게임매니아)
- **B**: 이모지 포함 (🎮 게임매니아)

### Test 2: 프로필 노출 위치
- **A**: 프로필 버튼만 제공
- **B**: 메인 화면에 미니 프로필 상시 노출

### Test 3: 유료 기능 안내 타이밍
- **A**: 수정 버튼 클릭 시 유료 안내
- **B**: 프로필 화면에 프로모션 배너 표시

**측정 지표**:
- 룸메이트 프로필 조회율
- 첫 대화 시작률
- 유료 전환율 (키워드 수정 시도 → 구독)
