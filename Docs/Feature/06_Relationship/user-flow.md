# 관계 역학 시스템 - 사용자 플로우

## 플로우 다이어그램

```
[이웃 노크 / 룸메이트 최초 만남]
    ↓
[관계 레벨 1 (또는 룸메이트는 3)]
    ↓
[대화 시작]
    ↓
[상호작용 추적]
    ↓
[대화 종료]
    ↓
[세션 분석 (감정, 주제, 시간)]
    ↓
[친밀도 점수 계산]
    ↓
[점수 업데이트]
    ↓
    ├─ [레벨 임계값 미도달] → [관계 유지]
    │                              ↓
    │                         [다음 대화]
    │
    └─ [레벨 임계값 도달] → [레벨업]
                              ↓
                         [프롬프트 업데이트]
                              ↓
                         [레벨업 알림 표시]
                              ↓
                         [다음 대화 (새 말투)]
```

---

## 상세 단계별 플로우

### Step 1: 최초 관계 설정
**트리거**:
- 신규 이웃 노크 성공 → 레벨 1 (낯선 사이)
- 온보딩 완료 (룸메이트) → 레벨 3 (친한 사이)

**백엔드 프로세스**:
```javascript
POST /api/v1/relationship/create
{
  "personaId": "persona_123",
  "initialLevel": 1, // 이웃은 1, 룸메이트는 3
  "personaType": "neighbor" | "roommate"
}

Response:
{
  "relationship": {
    "level": 1,
    "levelName": "낯선 사이",
    "intimacyScore": 0,
    "createdAt": "2025-10-27T10:00:00Z"
  }
}
```

**화면 표시**:
```
┌─────────────────────────────────────┐
│  새로운 이웃을 발견했습니다!        │
│                                     │
│  [이웃 이미지]                      │
│  ⭐☆☆☆☆ 낯선 사이 (Lv.1)          │
│                                     │
│  첫 인사를 나눠보세요!              │
│  [대화 시작하기]                    │
└─────────────────────────────────────┘
```

---

### Step 2: 첫 대화 (레벨 1: 낯선 사이)
**목표**: 예의 바른 첫 인사

**AI 응답 특징**:
- 존댓말 사용
- 짧고 간결한 답변
- 조심스러운 태도

**대화 예시**:
```
사용자: "안녕하세요"
AI: "안녕하세요! 처음 뵙네요. 반갑습니다."

사용자: "여기 사신 지 오래되셨어요?"
AI: "네, 꽤 오래 살았어요. 앞으로 자주 인사해요."
```

**관계 게이지 표시**:
```
┌─────────────────────────────────────┐
│  [이웃 이름]                        │
│  ⭐☆☆☆☆ 낯선 사이 (Lv.1)          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━     │
│  0 / 20                             │
└─────────────────────────────────────┘
```

**소요 시간**: 5-10분

---

### Step 3: 대화 종료 및 세션 분석
**트리거**: 사용자가 채팅 모달 닫기

**백엔드 프로세스**:
1. 세션 데이터 수집
   - 메시지 개수: 15개
   - 대화 시간: 8분
   - 감정 분석: 긍정 (joy, +7)
   - 주제 일치도: 6/10

2. 친밀도 점수 계산
   ```
   기본 대화 완료: +2
   긍정적 대화: +5
   총 획득 점수: +7
   ```

3. 점수 업데이트
   ```javascript
   POST /api/v1/relationship/persona_123/update-score
   {
     "sessionId": "session_789",
     "points": 7,
     "reason": "positive_first_conversation"
   }
   ```

**결과**:
- 이전 점수: 0
- 새 점수: 7
- 레벨: 1 유지 (20점 필요)

---

### Step 4: 반복 대화 (점수 누적)
**대화 2회차** (다음 날):
```
사용자: "어제는 감사했어요"
AI: "아, 별말씀을요! 즐거웠어요 😊"
→ 점수 +5 (긍정 대화)
총 점수: 12/20
```

**대화 3회차**:
```
사용자: "요즘 관심사가 뭐예요?"
AI: "저는 음악 듣는 거 좋아해요. 요즘 인디 음악에 푹 빠져있어요 🎵"
→ 점수 +2 (기본 대화)
총 점수: 14/20
```

**대화 4회차**:
```
사용자: "저도 음악 좋아해요! 추천해주실 거 있나요?"
AI: "오! 진짜요? 그럼 이 노래 들어보세요~ (링크) 분위기 정말 좋아요"
→ 점수 +5 (주제 일치, 긍정)
총 점수: 19/20
```

**게이지 변화**:
```
┌─────────────────────────────────────┐
│  [이웃 이름]                        │
│  ⭐☆☆☆☆ 낯선 사이 (Lv.1)          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━     │
│  19 / 20 (거의 다 찼음!)            │
└─────────────────────────────────────┘
```

---

### Step 5: 레벨업 달성
**대화 5회차**:
```
사용자: "오늘도 좋은 하루 보내세요!"
AI: "감사합니다! 당신도 좋은 하루 되세요 😊"
→ 점수 +2
총 점수: 21/20 → 레벨업!
```

**백엔드 프로세스**:
```javascript
Response from update-score:
{
  "success": true,
  "previousScore": 19,
  "newScore": 21,
  "levelChanged": true,
  "previousLevel": 1,
  "currentLevel": 2,
  "levelName": "알게 된 사이",
  "notification": {
    "title": "관계가 발전했습니다!",
    "message": "[이웃 이름]님과 알게 된 사이가 되었습니다!"
  }
}
```

---

### Step 6: 레벨업 알림 표시
**화면 UI**:
```
┌─────────────────────────────────────┐
│  🎉 관계가 발전했습니다!            │
│                                     │
│  [이웃 이름]님과의 관계가           │
│  "낯선 사이"에서                    │
│  "알게 된 사이"로 발전했습니다!     │
│                                     │
│  ⭐⭐☆☆☆ 알게 된 사이 (Lv.2)      │
│                                     │
│  이제 더 편안한 대화를 나눌 수 있어요│
│                                     │
│  [확인]                             │
└─────────────────────────────────────┘
```

**애니메이션**:
- 게이지 채워지는 효과
- 별 아이콘 밝아지는 효과
- 축하 파티클 효과

**소요 시간**: 3-5초 (애니메이션 포함)

---

### Step 7: 프롬프트 자동 업데이트
**백엔드 프로세스**:
```typescript
// 시스템 프롬프트의 [관계], [말투] 섹션 교체
const updatedPrompt = `
[역할]
당신은 AI 이웃입니다.

[성격]
${기존 성격 유지}

[관계]  ← 변경됨
당신은 사용자와 몇 번 대화를 나눈 이웃입니다.
조금씩 친해지고 있으므로 편안한 분위기를 만들어가세요.

[말투]  ← 변경됨
- 존댓말과 반말 혼용 (부드럽게)
- 2-3문장 답변
- 가벼운 관심사 질문 가능
- 이모지 가끔 사용
`;

await updatePersonaPrompt(personaId, updatedPrompt);
```

---

### Step 8: 다음 대화 (새 말투 적용)
**사용자 재방문**:
```
사용자: "안녕하세요!"
AI: "어! 안녕~ 오늘 기분 좋아 보이는데? 😊"
```

**이전 (레벨 1)과 비교**:
```
[이전] "안녕하세요! 처음 뵙네요. 반갑습니다."
[현재] "어! 안녕~ 오늘 기분 좋아 보이는데? 😊"
```

**사용자 경험**:
- 말투가 더 편안해짐을 즉시 인지
- 관계 발전 피드백 제공
- 지속적 상호작용 동기 부여

---

### Step 9: 지속적 레벨업 (레벨 3, 4, 5)
**레벨 2 → 3 (친한 사이)**:
- 필요 점수: 50
- 예상 대화 횟수: 10-15회
- 변화: 친근한 반말, 더 적극적 공감

**레벨 3 → 4 (가까운 사이)**:
- 필요 점수: 100
- 예상 대화 횟수: 20-30회
- 변화: 깊은 대화, 개인 경험 공유

**레벨 4 → 5 (절친)**:
- 필요 점수: 200
- 예상 대화 횟수: 40-50회
- 변화: 매우 친밀한 반말, 농담/유머 자유로움

---

## 전체 타임라인

| 단계 | 대화 횟수 | 누적 점수 | 레벨 | 소요 기간 (예상) |
|------|----------|----------|------|-----------------|
| 최초 만남 | 0 | 0 | 1 | Day 0 |
| 첫 대화 | 1 | 7 | 1 | Day 1 |
| 레벨업 1→2 | 5 | 21 | 2 | Day 3-5 |
| 레벨업 2→3 | 15 | 52 | 3 | Day 10-14 |
| 레벨업 3→4 | 30 | 105 | 4 | Day 21-30 |
| 레벨업 4→5 | 50 | 205 | 5 | Day 40-60 |

**참고**: 실제 소요 기간은 대화 빈도 및 질에 따라 변동

---

## 사용자 시나리오

### 시나리오 1: 빠른 친밀도 상승
**사용자 행동**:
- 매일 접속
- 긍정적이고 깊은 대화
- 긴 대화 세션 (30분+)

**결과**:
- 2주 내 레벨 3 도달
- 높은 참여도
- 강한 애착 형성

---

### 시나리오 2: 느린 관계 발전
**사용자 행동**:
- 가끔 접속 (주 2-3회)
- 짧은 대화 (10분 이하)
- 일반적 주제

**결과**:
- 4주 내 레벨 2 도달
- 점진적 관계 형성
- 자연스러운 페이스

---

### 시나리오 3: 관계 정체
**사용자 행동**:
- 불규칙 접속
- 매우 짧은 대화
- 낮은 감정 교류

**결과**:
- 레벨 1 장기 유지
- 점수 느린 증가
- 재참여 유도 필요 (비동기 노크)

---

## 화면 구성

### 화면 1: 관계 상세 정보
```
┌─────────────────────────────────────┐
│  ← [이웃 이름]                      │
├─────────────────────────────────────┤
│  관계 레벨                          │
│  ⭐⭐⭐☆☆ 친한 사이 (Lv.3)        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━     │
│  65 / 100                           │
│                                     │
│  다음 레벨까지 35점 남았어요!       │
│                                     │
├─────────────────────────────────────┤
│  함께한 시간                        │
│  📅 7일 (처음 만난 후)              │
│  💬 15번의 대화                     │
│  ⏱️ 2시간 30분                     │
│                                     │
├─────────────────────────────────────┤
│  주요 대화 주제                     │
│  🎮 게임 (8회)                      │
│  🎵 음악 (5회)                      │
│  📺 영화 (2회)                      │
│                                     │
├─────────────────────────────────────┤
│  감정 분포                          │
│  😊 긍정 12회                       │
│  😐 평온 2회                        │
│  😢 부정 1회                        │
└─────────────────────────────────────┘
```

### 화면 2: 전체 관계 목록
```
┌─────────────────────────────────────┐
│  ← 나의 관계들                      │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐   │
│  │ 룸메이트                    │   │
│  │ ⭐⭐⭐⭐☆ 가까운 사이 (Lv.4)│   │
│  │ 125 / 200                   │   │
│  │ 마지막 대화: 2시간 전       │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 이웃1 (음악광)              │   │
│  │ ⭐⭐⭐☆☆ 친한 사이 (Lv.3)  │   │
│  │ 65 / 100                    │   │
│  │ 마지막 대화: 1일 전         │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 이웃2 (요리사)              │   │
│  │ ⭐⭐☆☆☆ 알게 된 사이 (Lv.2)│   │
│  │ 35 / 50                     │   │
│  │ 마지막 대화: 3일 전         │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## 이탈 방지 전략

### Critical Point 1: 초반 관계 형성 (레벨 1)
**리스크**: 처음에 흥미를 잃음

**대응**:
- 첫 대화부터 긍정적 경험 제공
- 관계 게이지로 진행도 명확히 표시
- "조금만 더 대화하면 친해질 수 있어요!" 힌트

### Critical Point 2: 중반 정체 (레벨 2-3)
**리스크**: 레벨업이 느려 지루함

**대응**:
- 주간 목표 제시 ("이번 주에 3번 대화하면 레벨업!")
- 관계 통계 시각화 (그래프)
- 비동기 노크로 재참여 유도

---

## A/B 테스트 아이디어

### Test 1: 레벨업 속도
- **A**: 현재 기준 (20, 50, 100, 200)
- **B**: 빠른 기준 (15, 35, 70, 150)

### Test 2: 레벨업 알림 타이밍
- **A**: 즉시 표시 (대화 종료 직후)
- **B**: 다음 접속 시 표시 (서프라이즈 효과)

### Test 3: 게이지 디자인
- **A**: 숫자 중심 (65/100)
- **B**: 비주얼 중심 (프로그레스 바, 별)

**측정 지표**: 레벨업 달성률, 평균 레벨, 대화 빈도
