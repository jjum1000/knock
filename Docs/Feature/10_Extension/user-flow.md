# Extension User Flows

## 목차

1. [첫 설치 및 온보딩](#첫-설치-및-온보딩)
2. [알림 받기 및 대화 시작](#알림-받기-및-대화-시작)
3. [팝업에서 빠른 대화](#팝업에서-빠른-대화)
4. [인라인 채팅 사용](#인라인-채팅-사용)
5. [브라우징 컨텍스트 활용](#브라우징-컨텍스트-활용)
6. [노크 시스템](#노크-시스템)
7. [웹앱으로 전환](#웹앱으로-전환)
8. [오류 시나리오](#오류-시나리오)

---

## 첫 설치 및 온보딩

### 플로우

```
1. Chrome 웹 스토어에서 Extension 설치
   ↓
2. Extension 아이콘 클릭 → 팝업 열림
   ↓
3. "시작하기" 버튼 클릭
   ↓
4. 권한 요청 화면
   - ✅ 알림 (필수)
   - ✅ 스토리지 (필수)
   - 🔒 브라우징 히스토리 (선택)
   ↓
5. 웹앱으로 리다이렉트 (새 탭)
   ↓
6. 웹앱에서 온보딩 진행
   - 캐릭터 생성
   - MBTI 입력
   - 관심사 선택
   - 첫 룸메이트 배정
   ↓
7. 온보딩 완료 → Extension 동기화
   ↓
8. 첫 알림 도착!
   "안녕! 나는 Alex야. 잘 부탁해!"
```

### 화면 구성

#### Step 1: Extension 설치 완료 팝업
```
┌─────────────────────────────────┐
│  🏠 KNOCK                       │
├─────────────────────────────────┤
│                                 │
│     ████  환영합니다!  ████     │
│                                 │
│   이웃과 대화를 시작하세요      │
│                                 │
│   [   🚀 시작하기   ]          │
│                                 │
└─────────────────────────────────┘
```

#### Step 2: 권한 요청
```
┌─────────────────────────────────┐
│  권한 설정                      │
├─────────────────────────────────┤
│                                 │
│ 필수 권한:                      │
│ ✅ 알림 표시                    │
│    → 룸메이트 메시지 알림       │
│                                 │
│ ✅ 데이터 저장                  │
│    → 대화 기록 보관             │
│                                 │
│ 선택 권한:                      │
│ ☐ 브라우징 히스토리             │
│    → AI 맞춤 대화 제공          │
│    (언제든 취소 가능)           │
│                                 │
│   [  취소  ]  [  허용하기  ]   │
│                                 │
└─────────────────────────────────┘
```

---

## 알림 받기 및 대화 시작

### 플로우 A: 룸메이트가 먼저 메시지 보냄

```
1. Background에서 이벤트 감지
   - 새 메시지 도착
   - 타임스탬프: 14:23
   ↓
2. Chrome 알림 표시
   "Alex 🎮"
   "너 오늘 뭐해? 같이 게임할래?"
   ↓
3. 사용자 선택:
   A) 알림 클릭 → 팝업 열림 (대화 화면)
   B) 알림 무시 → Badge 카운트 +1
   C) "답장" 액션 → 빠른 답장 입력
```

### 플로우 B: 사용자가 먼저 시작

```
1. Extension 아이콘 클릭
   ↓
2. 팝업 열림 (룸메이트 목록)
   ↓
3. 룸메이트 선택 (예: Alex)
   ↓
4. 채팅 화면 전환
   ↓
5. 메시지 입력 및 전송
   ↓
6. AI 응답 대기 (타이핑 애니메이션)
   ↓
7. 응답 수신 및 표시
```

### 화면 구성

#### 알림 (Chrome Notification)
```
┌─────────────────────────────────┐
│ 🏠 KNOCK                        │
│ ─────────────────────────────── │
│ Alex 🎮                         │
│ 너 오늘 뭐해? 같이 게임할래?    │
│                                 │
│ [답장]  [전체 대화 보기]        │
└─────────────────────────────────┘
```

#### 팝업 - 룸메이트 목록
```
┌─────────────────────────────────┐
│  🏠 KNOCK               [⚙️]    │
├─────────────────────────────────┤
│                                 │
│  내 룸메이트들                  │
│                                 │
│  ┌──────────────────────────┐  │
│  │ 🎮 Alex           🔴 1   │  │
│  │ "게임할래?"      14:23   │  │
│  └──────────────────────────┘  │
│                                 │
│  ┌──────────────────────────┐  │
│  │ 📚 Emma                  │  │
│  │ "안녕!"          어제    │  │
│  └──────────────────────────┘  │
│                                 │
│  ┌──────────────────────────┐  │
│  │ ☕ James                 │  │
│  │ "좋은 아침!"     3일전   │  │
│  └──────────────────────────┘  │
│                                 │
│  [🏠 건물 보기]  [+ 노크하기]  │
└─────────────────────────────────┘
```

---

## 팝업에서 빠른 대화

### 플로우

```
1. 팝업에서 룸메이트 선택 (Alex)
   ↓
2. 채팅 화면으로 전환
   ↓
3. 이전 대화 히스토리 로드 (최근 20개)
   ↓
4. 메시지 입력
   "오늘 5시에 할래!"
   ↓
5. Enter 또는 전송 버튼
   ↓
6. 메시지 Firestore에 저장
   ↓
7. AI 응답 요청 (OpenAI GPT)
   - 컨텍스트: 대화 히스토리
   - 컨텍스트: Alex의 성격 (게임 좋아함)
   - 컨텍스트: 사용자 브라우징 (게임 뉴스 많이 봄)
   ↓
8. 타이핑 애니메이션 표시 (1-2초)
   ↓
9. AI 응답 수신
   "좋아! 뭐 할래? LOL? 발로란트?"
   ↓
10. 응답 표시 + Firestore 저장
```

### 화면 구성

#### 채팅 화면
```
┌─────────────────────────────────┐
│  ← Alex 🎮          [⋮] [🏠]   │
├─────────────────────────────────┤
│                                 │
│  [Alex] 너 오늘 뭐해?           │
│         같이 게임할래?          │
│         14:23                   │
│                                 │
│              [나] 오늘 5시에!   │
│                   14:25         │
│                                 │
│  [Alex] 💭 typing...            │
│                                 │
│                                 │
│                                 │
├─────────────────────────────────┤
│  [메시지 입력...]       [📎] ↑ │
└─────────────────────────────────┘
```

#### 컨텍스트 적용된 응답 예시
```
사용자 브라우징:
- YouTube: LOL 프로 경기 하이라이트
- Reddit: r/leagueoflegends
- Steam: 게임 할인 정보

Alex의 응답:
"좋아! 뭐 할래? LOL? 발로란트?
 아 근데 너 어제 Faker 경기 봤어? 미쳤더라!"
                              ↑ 브라우징 컨텍스트 반영
```

---

## 인라인 채팅 사용

### 플로우

```
1. 사용자가 웹사이트 방문 (예: Reddit)
   ↓
2. Content Script 자동 주입
   ↓
3. 페이지 오른쪽 하단에 플로팅 버튼 표시
   [💬]
   ↓
4. 버튼 클릭
   ↓
5. 사이드 패널 슬라이드 인 (오른쪽에서 왼쪽)
   ↓
6. 채팅 인터페이스 표시
   - 현재 페이지 컨텍스트 자동 감지
   - "Reddit 보는 중..." 표시
   ↓
7. 메시지 입력 및 대화
   ↓
8. 사이드 패널 최소화/닫기
```

### 상호작용 시나리오

#### 시나리오 1: 뉴스 읽는 중
```
페이지: TechCrunch - "OpenAI GPT-5 발표"

사용자: [💬] 클릭

Alex: "오 AI 뉴스 보는구나!
       GPT-5 나왔대? 뭐가 달라졌어?"

사용자: "멀티모달 기능이 강화됐대"

Alex: "오 대박! 이미지도 더 잘 만들겠네.
       너 AI 관심 많구나?"
```

#### 시나리오 2: YouTube 시청 중
```
페이지: YouTube - "요리 레시피 영상"

사용자: [💬] 클릭

Emma: "요리하는구나! 뭐 만들어?
       나도 요리 좋아해!"

사용자: "파스타 만들려고"

Emma: "오 좋다! 토마토 소스? 크림 소스?
       내가 좋은 레시피 있는데 알려줄까?"
```

### 화면 구성

#### 플로팅 버튼
```
웹페이지 (예: Reddit)
─────────────────────────
                        │
  [일반 웹 콘텐츠]      │
                        │
                        │
                   ┌────┐
                   │ 💬 │ ← 플로팅 버튼
                   └────┘
```

#### 인라인 사이드 패널
```
웹페이지           │  Extension Panel
──────────────────┼──────────────────
                  │
  [웹 콘텐츠]     │  ← Emma 📚
  50% 너비        │  ──────────────
                  │
                  │  [Emma]
                  │  요리하는구나!
                  │
                  │       [나]
                  │       파스타!
                  │
                  │  [Emma] 💭
                  │
                  │  ──────────────
                  │  [메시지...]  ↑
```

---

## 브라우징 컨텍스트 활용

### 플로우

```
1. Background Service Worker 실행
   ↓
2. chrome.history API로 최근 방문 기록 수집
   - 최근 24시간
   - 최대 100개 URL
   ↓
3. 카테고리 분류 (AI 분석)
   - 기술: 30%
   - 게임: 25%
   - 요리: 15%
   - ...
   ↓
4. 관심사 프로필 업데이트
   Firestore: user_browsing_context
   ↓
5. 대화 시 컨텍스트 주입
   - OpenAI 시스템 프롬프트에 포함
   - "사용자는 최근 게임과 기술에 관심이 많음"
   ↓
6. 개인화된 응답 생성
```

### 컨텍스트 활용 예시

#### 예시 1: 게임 + 기술 관심사
```
브라우징 히스토리:
├─ YouTube: LOL 경기 (3회)
├─ Steam: 게임 할인 (5회)
├─ Hacker News (2회)
└─ GitHub (4회)

분석 결과:
- 게임: 40%
- 개발: 35%
- 기술: 25%

Alex의 대화:
"너 개발자야? 게임도 좋아하네!
 혹시 게임 개발에 관심 있어?
 Unity 써봤어?"
  ↑ 게임+개발 관심사 결합
```

#### 예시 2: 요리 + 건강
```
브라우징 히스토리:
├─ 쿠팡: 주방용품 (2회)
├─ YouTube: 다이어트 레시피 (4회)
├─ 네이버: 건강 정보 (3회)
└─ Instagram: 요리 계정 (5회)

분석 결과:
- 요리: 45%
- 건강: 30%
- 쇼핑: 25%

Emma의 대화:
"건강식 만들려고? 나도 요즘 그래!
 저칼로리 고단백 레시피 찾았는데
 관심 있어?"
  ↑ 요리+건강 관심사 결합
```

---

## 노크 시스템

### 플로우

```
1. 팝업에서 "노크하기" 버튼 클릭
   ↓
2. 건물 뷰 표시
   - 8개 방 (1-2개 빈방)
   - 내 방은 하이라이트
   ↓
3. 빈 방 선택
   ↓
4. 노크 확인 다이얼로그
   "이 방에 노크하시겠습니까?"
   "오늘의 노크: 1/1 사용"
   ↓
5. 확인 클릭
   ↓
6. 노크 애니메이션 (2초)
   "똑똑똑... 🚪"
   ↓
7. AI가 새 룸메이트 생성
   - 랜덤 성격 (MBTI)
   - 랜덤 관심사
   - 사용자 브라우징과 호환성 고려
   ↓
8. 룸메이트 등장!
   "안녕! 나는 Sophie야.
    음악 듣는 거 좋아해!"
   ↓
9. 자동으로 채팅 화면 전환
```

### 화면 구성

#### 건물 뷰
```
┌─────────────────────────────────┐
│  건물 뷰               [← 뒤로] │
├─────────────────────────────────┤
│                                 │
│  🏠 우리 건물                   │
│                                 │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐  │
│  │Alex│ │Emma│ │James│ │ ? │  │
│  │ 🎮 │ │ 📚 │ │ ☕ │ │   │  │
│  └────┘ └────┘ └────┘ └────┘  │
│   101    102    103    104     │
│                    ↑ 빈방       │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐  │
│  │ 나 │ │Mike│ │Sara│ │ ? │  │
│  │ 👤 │ │ 🎨 │ │ 🎵 │ │   │  │
│  └────┘ └────┘ └────┘ └────┘  │
│   201    202    203    204     │
│    ↑                    ↑ 빈방 │
│  내 방                          │
│                                 │
│  오늘의 노크: ⭐ (1/1)         │
│                                 │
│  [ 빈 방에 노크하기 ]          │
└─────────────────────────────────┘
```

#### 노크 진행 중
```
┌─────────────────────────────────┐
│  노크 중...                     │
├─────────────────────────────────┤
│                                 │
│                                 │
│         ┌────┐                  │
│         │ ? │                   │
│         │   │ 똑똑똑... 🚪      │
│         └────┘                  │
│          104                    │
│                                 │
│    새로운 이웃을 찾는 중...     │
│                                 │
│         [██████    ] 60%        │
│                                 │
└─────────────────────────────────┘
```

#### 새 룸메이트 등장
```
┌─────────────────────────────────┐
│  새 이웃!                       │
├─────────────────────────────────┤
│                                 │
│         ████████                │
│        █  🎵  █                 │
│         ████████                │
│                                 │
│        Sophie                   │
│                                 │
│    "안녕! 나는 Sophie야.        │
│     음악 듣는 거 좋아해!        │
│     잘 부탁해!"                 │
│                                 │
│   관심사: 음악, K-pop, 콘서트   │
│   성격: ENFP (활발함)           │
│                                 │
│   [  대화 시작하기  ]          │
│                                 │
└─────────────────────────────────┘
```

---

## 웹앱으로 전환

### 플로우

```
1. Extension 팝업에서 "건물 보기" 클릭
   ↓
2. 새 탭에서 웹앱 열림
   https://knock.app/building
   ↓
3. Extension과 동기화된 상태 표시
   - 같은 Firebase 계정
   - 같은 룸메이트들
   - 같은 대화 히스토리
   ↓
4. 웹앱에서 긴 대화 진행
   ↓
5. 웹앱 닫아도 Extension은 계속 실행
   - 알림 계속 수신
   - 백그라운드 동기화
```

### 전환 시점

#### 시점 1: 긴 대화 필요
```
Extension 팝업:
- 작은 화면 (360x600)
- 빠른 대화용

웹앱:
- 큰 화면 (전체 브라우저)
- 여러 룸메이트 동시 대화
- 대화 히스토리 검색
- 이미지/파일 공유
```

#### 시점 2: 설정 변경
```
Extension:
[⚙️] 아이콘 클릭
  ↓
"자세한 설정은 웹앱에서"
  ↓
웹앱 /settings 페이지 열림
```

#### 시점 3: 온보딩 완료 후 복귀
```
온보딩 (웹앱):
캐릭터 생성 → 룸메이트 배정
  ↓
완료 후:
"Extension으로 돌아가서
 알림을 확인하세요!"
  ↓
Extension 팝업 자동 활성화
```

---

## 오류 시나리오

### 1. 네트워크 오류

#### 플로우
```
1. 메시지 전송 시도
   ↓
2. Firestore 연결 실패
   ↓
3. 재시도 (3회, 지수 백오프)
   ↓
4. 모두 실패 시:
   - 로컬 스토리지에 임시 저장
   - 오류 메시지 표시
   "⚠️ 연결 실패. 메시지는 저장되었습니다."
   ↓
5. 네트워크 복구 감지
   ↓
6. 자동으로 메시지 재전송
   ↓
7. 성공 알림
   "✅ 메시지가 전송되었습니다!"
```

#### 화면
```
┌─────────────────────────────────┐
│  ← Alex 🎮                      │
├─────────────────────────────────┤
│                                 │
│              [나] 안녕!         │
│                   14:25 ⏳      │
│                   전송 중...    │
│                                 │
│  ⚠️ 연결이 불안정합니다         │
│     다시 시도하는 중... (2/3)  │
│                                 │
│     [취소]  [수동 재시도]      │
│                                 │
└─────────────────────────────────┘
```

### 2. AI 응답 오류

#### 플로우
```
1. AI 응답 요청 (OpenAI)
   ↓
2. API 오류 (429, 500, etc.)
   ↓
3. Fallback 응답 사용
   - 사전 정의된 대체 응답
   - 성격에 맞는 간단한 응답
   ↓
4. 사용자에게 표시
   "미안, 지금 좀 정신없어. 나중에 다시 말해줄래?"
   ↓
5. 백그라운드에서 재시도
   ↓
6. 성공 시 추가 응답 전송
```

#### 화면
```
┌─────────────────────────────────┐
│  ← Alex 🎮                      │
├─────────────────────────────────┤
│                                 │
│              [나] 뭐해?         │
│                   14:25         │
│                                 │
│  [Alex] 미안, 지금 좀 정신없어. │
│         나중에 다시 말해줄래?   │
│         14:26                   │
│                                 │
│  ℹ️ AI 응답 일시적 오류         │
│                                 │
└─────────────────────────────────┘
```

### 3. 권한 없음 (브라우징 히스토리)

#### 플로우
```
1. Extension 설치 시 권한 거부
   ↓
2. 기본 기능은 정상 작동
   - 알림, 채팅, 노크 모두 가능
   ↓
3. 대화는 일반적인 컨텍스트만 사용
   - 브라우징 데이터 없이 진행
   ↓
4. 설정에서 권한 요청 배너 표시
   "브라우징 히스토리 권한을 허용하면
    더 개인화된 대화를 즐길 수 있어요!"
   ↓
5. 사용자가 나중에 권한 허용 가능
```

#### 화면
```
┌─────────────────────────────────┐
│  🏠 KNOCK               [⚙️]    │
├─────────────────────────────────┤
│                                 │
│  ℹ️ 더 나은 경험을 위해         │
│                                 │
│  브라우징 히스토리 권한을       │
│  허용하시겠어요?                │
│                                 │
│  ✅ AI가 당신의 관심사를 이해   │
│  ✅ 더 자연스러운 대화          │
│  ✅ 맞춤형 추천                 │
│                                 │
│  [ 나중에 ]  [ 허용하기 ]      │
│                                 │
└─────────────────────────────────┘
```

### 4. 노크 한도 초과

#### 플로우
```
1. 오늘 이미 1회 노크 사용
   ↓
2. 다시 "노크하기" 클릭
   ↓
3. 안내 메시지 표시
   "오늘의 노크를 모두 사용했어요!
    내일 다시 올게요."
   ↓
4. 다음 노크 가능 시간 표시
   "00:00:00 후 노크 가능"
   ↓
5. 대안 제시
   "현재 룸메이트들과 대화해보세요!"
```

#### 화면
```
┌─────────────────────────────────┐
│  노크 한도 초과                 │
├─────────────────────────────────┤
│                                 │
│         ⏰                       │
│                                 │
│   오늘의 노크를 모두 사용했어요! │
│                                 │
│   다음 노크 가능:               │
│   09:23:45 후                   │
│                                 │
│   💡 대신 이렇게 해보세요:      │
│                                 │
│   • 현재 룸메이트와 대화하기    │
│   • 대화 히스토리 둘러보기      │
│   • 프로필 업데이트하기         │
│                                 │
│   [  확인  ]                    │
│                                 │
└─────────────────────────────────┘
```

### 5. 로그인 만료

#### 플로우
```
1. Firebase Auth 토큰 만료
   ↓
2. API 요청 실패 (401)
   ↓
3. 자동 토큰 갱신 시도
   ↓
4. 갱신 실패 시:
   - 로컬 데이터는 보존
   - 로그인 화면 표시
   ↓
5. 사용자 재로그인
   ↓
6. 데이터 동기화 복구
```

#### 화면
```
┌─────────────────────────────────┐
│  세션 만료                      │
├─────────────────────────────────┤
│                                 │
│         🔐                       │
│                                 │
│   로그인 세션이 만료되었습니다. │
│                                 │
│   다시 로그인하여 룸메이트들과  │
│   대화를 이어가세요!            │
│                                 │
│   💾 대화 기록은 안전하게       │
│      보관되어 있습니다.         │
│                                 │
│   [  다시 로그인  ]            │
│                                 │
└─────────────────────────────────┘
```

---

## 사용 패턴 분석

### 일반적인 사용자 여정

```
아침 (07:00-09:00):
├─ 알림 수신: "좋은 아침!"
├─ 팝업에서 빠른 답장
└─ 하루 시작

업무/학업 중 (09:00-18:00):
├─ 웹서핑 중 인라인 채팅
├─ 관련 주제로 대화
└─ 알림은 최소화

저녁 (18:00-23:00):
├─ 웹앱에서 긴 대화
├─ 노크로 새 룸메이트 추가
└─ 여러 룸메이트와 동시 대화

심야 (23:00-07:00):
└─ 알림 끄기 (선택)
```

### 주요 상호작용 포인트

1. **알림 → 팝업 대화** (가장 빈번)
2. **팝업 → 웹앱 전환** (주 2-3회)
3. **인라인 채팅 사용** (주 5-7회)
4. **노크 시스템** (일 1회)
5. **설정 변경** (월 1-2회)

---

## 다음 단계

문서 완성 후:
1. ✅ `README.md` - Extension 개요
2. ✅ `feature-spec.md` - 기능 명세
3. ✅ `user-flow.md` - 사용자 플로우 (현재 문서)
4. ⬜ `tech-spec.md` - 기술 명세

이후 구현:
1. Chrome Extension 프로젝트 초기화
2. Manifest V3 설정
3. React 팝업 UI 구축
4. Background Service Worker 구현
5. Content Script & Inline Chat
6. Firebase & OpenAI 통합
