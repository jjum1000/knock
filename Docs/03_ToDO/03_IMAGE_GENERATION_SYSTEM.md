# ì´ë¯¸ì§€ ìƒì„± ì‹œìŠ¤í…œ ìƒì„¸ ì„¤ê³„
**ì‘ì„±ì¼**: 2025-10-28
**ëª©ì **: ìš•êµ¬ ë²¡í„° ê¸°ë°˜ ë£¸ë©”ì´íŠ¸ ë°© ì´ë¯¸ì§€ ìë™ ìƒì„± ì‹œìŠ¤í…œ êµ¬í˜„

---

## ğŸ“‹ ê°œìš”

ìºë¦­í„°ì˜ **ë‚´ë©´(WHY)**ì—ì„œ ì‹œì‘í•˜ì—¬ ìì—°ìŠ¤ëŸ½ê²Œ ì™¸ëª¨, ìŠ¤íƒ€ì¼, ê³µê°„ì´ ë°œí˜„ë˜ë„ë¡ í•˜ëŠ” ì´ë¯¸ì§€ ìƒì„± íŒŒì´í”„ë¼ì¸ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

---

## ğŸ¯ í•µì‹¬ ì›ì¹™

### 1. ë‚´ë©´ â†’ ì™¸ë©´ ë°œí˜„
```
ê·¼ì›ì  ìš•êµ¬ (WHY)
    â†“
íŠ¸ë¼ìš°ë§ˆ/ê²½í—˜
    â†“
ì‹œê°ì  ìš”ì†Œ ìë™ ì„ íƒ
    â†“
ì¼ê´€ì„± ìˆëŠ” ì´ë¯¸ì§€
```

### 2. í¸í–¥ íšŒí”¼
- ìŠ¤í…Œë ˆì˜¤íƒ€ì… ì§ì ‘ ì‚¬ìš© ê¸ˆì§€
- ìš•êµ¬ ë²¡í„°ë¥¼ ì‹œê°ì  ì–¸ì–´ë¡œ ë³€í™˜ (ê°„ì ‘ ë§¤í•‘)
- ê°™ì€ ìš•êµ¬ â†’ ë‹¤ì–‘í•œ ì‹œê°ì  í‘œí˜„ ê°€ëŠ¥

### 3. í•˜ì´ë¸Œë¦¬ë“œ ì‹œìŠ¤í…œ
- **ê²°ì •ë¡ ì **: ìš•êµ¬ â†’ ìƒ‰ìƒ/ë¶„ìœ„ê¸° (ì¼ê´€ì„±)
- **í™•ë¥ ë¡ ì **: êµ¬ì²´ì  ì˜¤ë¸Œì íŠ¸/ìŠ¤íƒ€ì¼ (ë‹¤ì–‘ì„±)

---

## ğŸ”„ ì „ì²´ íŒŒì´í”„ë¼ì¸

```
[ìºë¦­í„° ìš•êµ¬ ë²¡í„°]
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: ìš•êµ¬ â†’ ì‹œê°ì  ì–¸ì–´ ë§¤í•‘      â”‚
â”‚ - ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì„ íƒ                   â”‚
â”‚ - ê³µê°„ ìŠ¤íƒ€ì¼ ì •ì˜                   â”‚
â”‚ - ë¶„ìœ„ê¸° ê²°ì •                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: íŠ¸ë¼ìš°ë§ˆ â†’ ë°©ì–´ ìš”ì†Œ         â”‚
â”‚ - ë³´í˜¸ ì•„ì´í…œ ì¶”ê°€                   â”‚
â”‚ - ì•ˆì „ ê³µê°„ ìš”ì†Œ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: ì•„í‚¤íƒ€ì… ê¸°ë°˜ ì˜¤ë¸Œì íŠ¸ ì„ íƒ  â”‚
â”‚ - í™•ë¥ ì  ì˜¤ë¸Œì íŠ¸ ìƒ˜í”Œë§             â”‚
â”‚ - ì¼ê´€ì„± ê²€ì¦                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì¡°ë¦½         â”‚
â”‚ - êµ¬ì¡° + ë¶„ìœ„ê¸° ë³‘í•©                 â”‚
â”‚ - ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ ì¶”ê°€             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: AI ì´ë¯¸ì§€ ìƒì„±               â”‚
â”‚ - Gemini Imagen API í˜¸ì¶œ             â”‚
â”‚ - í’ˆì§ˆ ê²€ì¦                          â”‚
â”‚ - Fallback ì²˜ë¦¬                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Step 1: ìš•êµ¬ â†’ ì‹œê°ì  ì–¸ì–´ ë§¤í•‘

### ë§¤í•‘ í…Œì´ë¸”

```typescript
interface VisualLanguage {
  colors: {
    primary: string;
    secondary: string;
    accent: string;
  };
  space: {
    layout: string;
    organization: string;
    openness: string;
  };
  lighting: {
    type: string;
    intensity: string;
    source: string;
  };
  mood: string;
}

const NEED_TO_VISUAL: Record<string, VisualLanguage> = {
  // ì†Œì† ìš•êµ¬ (Belonging)
  belonging: {
    colors: {
      primary: 'warm orange tones',
      secondary: 'soft yellow',
      accent: 'gentle pink or peach'
    },
    space: {
      layout: 'clustered and intimate',
      organization: 'comfortable mess',
      openness: 'cozy enclosed feeling'
    },
    lighting: {
      type: 'warm natural light',
      intensity: 'soft and gentle',
      source: 'window with curtains, warm lamp'
    },
    mood: 'Safe, welcoming, embracing atmosphere where you want to stay'
  },

  // ì¸ì • ìš•êµ¬ (Recognition)
  recognition: {
    colors: {
      primary: 'calm navy blue',
      secondary: 'professional gray',
      accent: 'white or silver highlights'
    },
    space: {
      layout: 'symmetrical and balanced',
      organization: 'highly organized',
      openness: 'open and showcasing'
    },
    lighting: {
      type: 'bright focused light',
      intensity: 'clear and sharp',
      source: 'desk lamp, spotlight on achievements'
    },
    mood: 'Professional, accomplished, competent atmosphere with visible proof of worth'
  },

  // ììœ¨ ìš•êµ¬ (Autonomy)
  autonomy: {
    colors: {
      primary: 'deep purple or indigo',
      secondary: 'unique color combinations',
      accent: 'unexpected contrasts'
    },
    space: {
      layout: 'asymmetric and personal',
      organization: 'organized chaos',
      openness: 'personal boundaries defined'
    },
    lighting: {
      type: 'customized lighting',
      intensity: 'controllable mood lighting',
      source: 'RGB lights, dimmer switches, personal preference'
    },
    mood: 'Independent, unique, rule-breaking atmosphere with personal expression'
  },

  // ì„±ì¥ ìš•êµ¬ (Growth)
  growth: {
    colors: {
      primary: 'vibrant green',
      secondary: 'energetic blue',
      accent: 'bright yellow or white'
    },
    space: {
      layout: 'expandable and evolving',
      organization: 'work-in-progress feel',
      openness: 'open for new additions'
    },
    lighting: {
      type: 'natural bright light',
      intensity: 'energizing brightness',
      source: 'large window, daylight, plant-growing lamps'
    },
    mood: 'Dynamic, evolving, learning-in-progress atmosphere with room to grow'
  },

  // ì•ˆì „ ìš•êµ¬ (Survival)
  survival: {
    colors: {
      primary: 'neutral beige or taupe',
      secondary: 'calm earth tones',
      accent: 'minimal contrast'
    },
    space: {
      layout: 'predictable and routine',
      organization: 'extremely tidy',
      openness: 'protected and enclosed'
    },
    lighting: {
      type: 'consistent ambient light',
      intensity: 'moderate no extremes',
      source: 'overhead stable lighting, night light'
    },
    mood: 'Safe, predictable, calm atmosphere with no surprises'
  },

  // ì˜ë¯¸ ìš•êµ¬ (Meaning)
  meaning: {
    colors: {
      primary: 'deep navy or midnight blue',
      secondary: 'rich burgundy or purple',
      accent: 'gold or bronze highlights'
    },
    space: {
      layout: 'thoughtful and intentional',
      organization: 'meaningful arrangement',
      openness: 'contemplative spaces'
    },
    lighting: {
      type: 'dramatic focused lighting',
      intensity: 'soft shadows and highlights',
      source: 'candles, reading lamp, symbolic light'
    },
    mood: 'Deep, contemplative, purposeful atmosphere with symbolic elements'
  }
};
```

### ë³µí•© ìš•êµ¬ ë¸”ë Œë”©

```typescript
function blendVisualLanguages(
  needs: Array<{need: string; intensity: number}>
): VisualLanguage {

  // ê°•ë„ ê¸°ë°˜ ê°€ì¤‘ í‰ê· 
  const totalIntensity = needs.reduce((sum, n) => sum + n.intensity, 0);

  const blended: VisualLanguage = {
    colors: {primary: '', secondary: '', accent: ''},
    space: {layout: '', organization: '', openness: ''},
    lighting: {type: '', intensity: '', source: ''},
    mood: ''
  };

  // ê°€ì¥ ê°•í•œ ìš•êµ¬ì˜ ìƒ‰ìƒì„ primaryë¡œ
  const dominant = needs.sort((a, b) => b.intensity - a.intensity)[0];
  blended.colors.primary = NEED_TO_VISUAL[dominant.need].colors.primary;

  // ë‘ ë²ˆì§¸ ê°•í•œ ìš•êµ¬ì˜ ìƒ‰ìƒì„ secondaryë¡œ
  if (needs.length > 1) {
    blended.colors.secondary = NEED_TO_VISUAL[needs[1].need].colors.secondary;
  }

  // accentëŠ” ì„¸ ë²ˆì§¸ ë˜ëŠ” ì²« ë²ˆì§¸ ìš•êµ¬ì—ì„œ
  blended.colors.accent = needs.length > 2
    ? NEED_TO_VISUAL[needs[2].need].colors.accent
    : NEED_TO_VISUAL[dominant.need].colors.accent;

  // ê³µê°„/ì¡°ëª…/ë¶„ìœ„ê¸°ëŠ” ê°€ì¥ ê°•í•œ ìš•êµ¬ ê¸°ë°˜
  blended.space = NEED_TO_VISUAL[dominant.need].space;
  blended.lighting = NEED_TO_VISUAL[dominant.need].lighting;

  // ë¶„ìœ„ê¸°ëŠ” ëª¨ë“  ìš•êµ¬ ì¡°í•©
  blended.mood = needs.map(n =>
    NEED_TO_VISUAL[n.need].mood
  ).join(' blended with ');

  return blended;
}
```

---

## Step 2: íŠ¸ë¼ìš°ë§ˆ â†’ ë°©ì–´ ìš”ì†Œ

### íŠ¸ë¼ìš°ë§ˆ íƒ€ì…ë³„ ë°©ì–´ ìš”ì†Œ

```typescript
interface DefensiveElement {
  object: string;
  placement: string;
  symbolism: string;
}

const TRAUMA_TO_DEFENSE: Record<string, DefensiveElement[]> = {
  // ì™•ë”°/ê±°ë¶€ ê²½í—˜
  rejection: [
    {
      object: 'oversized hoodie on chair',
      placement: 'easily accessible near desk',
      symbolism: 'protective layer, ability to hide and feel safe'
    },
    {
      object: 'large over-ear headphones',
      placement: 'on desk or hanging on wall',
      symbolism: 'sound barrier, create own world, control what enters'
    },
    {
      object: 'small enclosed reading nook or fort-like bed',
      placement: 'corner of room',
      symbolism: 'safe enclosed space, protection from outside'
    }
  ],

  // ì¡°ê±´ë¶€ ì‚¬ë‘/ì¸ì • ê²½í—˜
  conditional_love: [
    {
      object: 'achievement certificates perfectly aligned',
      placement: 'prominently displayed on wall',
      symbolism: 'proof of worth, visible validation'
    },
    {
      object: 'extremely organized desk with labels',
      placement: 'center of room',
      symbolism: 'control and perfection as safety'
    },
    {
      object: 'trophies or medals on shelf',
      placement: 'at eye level when entering',
      symbolism: 'constant reminder of being good enough'
    }
  ],

  // ê°ì • ë¬´ì‹œ/ì–µì•• ê²½í—˜
  emotional_suppression: [
    {
      object: 'art supplies or creative tools',
      placement: 'scattered but accessible',
      symbolism: 'outlet for suppressed emotions'
    },
    {
      object: 'journal or sketchbook',
      placement: 'partially hidden but present',
      symbolism: 'private emotional expression'
    },
    {
      object: 'music instruments or recording equipment',
      placement: 'corner dedicated to expression',
      symbolism: 'non-verbal emotional release'
    }
  ],

  // í†µì œ ìƒì‹¤ ê²½í—˜
  loss_of_control: [
    {
      object: 'everything perfectly symmetric',
      placement: 'strict grid layout',
      symbolism: 'regaining control through order'
    },
    {
      object: 'labeled storage boxes',
      placement: 'stacked precisely',
      symbolism: 'everything has its place, predictability'
    },
    {
      object: 'routine-based calendar or schedule board',
      placement: 'visible wall space',
      symbolism: 'control over time and future'
    }
  ],

  // í˜¼ìë¨/ê³ ë¦½ ê²½í—˜
  isolation: [
    {
      object: 'online community symbols (game merch, fandom posters)',
      placement: 'multiple around room',
      symbolism: 'connection to chosen communities'
    },
    {
      object: 'multiple communication devices always charged',
      placement: 'within arms reach',
      symbolism: 'always ready to connect, never truly alone'
    },
    {
      object: 'small potted plant',
      placement: 'desk or windowsill',
      symbolism: 'something alive to care for, gentle companionship'
    }
  ]
};

function selectDefensiveElements(
  traumaTypes: string[]
): DefensiveElement[] {

  const elements: DefensiveElement[] = [];

  traumaTypes.forEach(trauma => {
    const options = TRAUMA_TO_DEFENSE[trauma] || [];
    // ê° íŠ¸ë¼ìš°ë§ˆì—ì„œ 1-2ê°œ ëœë¤ ì„ íƒ
    const selected = randomSample(options, Math.min(2, options.length));
    elements.push(...selected);
  });

  return elements;
}
```

---

## Step 3: ì•„í‚¤íƒ€ì… ê¸°ë°˜ ì˜¤ë¸Œì íŠ¸ ì„ íƒ

### ì•„í‚¤íƒ€ì… ì •ì˜

```typescript
interface Archetype {
  name: string;
  matchingNeeds: string[];    // ì´ ì•„í‚¤íƒ€ì…ê³¼ ë§ëŠ” ìš•êµ¬ë“¤
  objects: ArchetypeObject[];
}

interface ArchetypeObject {
  name: string;
  weight: number;             // ì¶œí˜„ í™•ë¥  ê°€ì¤‘ì¹˜
  requirement?: string;       // ì¡°ê±´ (ì„ íƒì )
}

const ARCHETYPES: Archetype[] = [
  {
    name: 'developer_gamer',
    matchingNeeds: ['recognition', 'belonging', 'autonomy'],
    objects: [
      { name: 'dual monitors with code editor UI', weight: 0.9 },
      { name: 'RGB mechanical keyboard', weight: 0.8 },
      { name: 'gaming posters (pixel art indie games)', weight: 0.7 },
      { name: 'energy drink cans on desk', weight: 0.5 },
      { name: 'small succulent plant', weight: 0.6 },
      { name: 'controller stand with multiple controllers', weight: 0.4 },
      { name: 'LED strip lights behind monitor', weight: 0.7 },
      { name: 'cable management visible', weight: 0.3, requirement: 'recognition > 0.7' }
    ]
  },

  {
    name: 'minimalist_achiever',
    matchingNeeds: ['recognition', 'autonomy', 'survival'],
    objects: [
      { name: 'single clean desk with laptop', weight: 0.9 },
      { name: 'achievement frames perfectly aligned', weight: 0.8 },
      { name: 'single small plant (exactly one)', weight: 0.7 },
      { name: 'neutral color bookshelf organized by size', weight: 0.6 },
      { name: 'simple geometric art', weight: 0.5 },
      { name: 'nothing on floor (extremely clean)', weight: 0.9 },
      { name: 'minimalist clock', weight: 0.4 }
    ]
  },

  {
    name: 'cozy_creative',
    matchingNeeds: ['belonging', 'growth', 'meaning'],
    objects: [
      { name: 'fairy lights strung across ceiling', weight: 0.8 },
      { name: 'multiple plants of varying sizes', weight: 0.9 },
      { name: 'art supplies scattered but organized', weight: 0.7 },
      { name: 'polaroid photos on wall in casual arrangement', weight: 0.8 },
      { name: 'cozy reading chair with blanket', weight: 0.9 },
      { name: 'handmade crafts displayed', weight: 0.6 },
      { name: 'warm table lamp', weight: 0.8 },
      { name: 'bookshelf with mixed books and trinkets', weight: 0.7 }
    ]
  },

  {
    name: 'focused_learner',
    matchingNeeds: ['growth', 'recognition', 'meaning'],
    objects: [
      { name: 'large desk with open textbooks', weight: 0.9 },
      { name: 'whiteboard with notes and diagrams', weight: 0.8 },
      { name: 'organized bookshelf full of books', weight: 0.9 },
      { name: 'desk lamp with bright focused light', weight: 0.8 },
      { name: 'sticky notes with study plans', weight: 0.6 },
      { name: 'coffee mug and water bottle', weight: 0.7 },
      { name: 'world map or educational posters', weight: 0.5 },
      { name: 'notebook stack organized by subject', weight: 0.6 }
    ]
  }
];

function selectArchetype(
  needs: Array<{need: string; intensity: number}>
): Archetype {

  // ìš•êµ¬ ë²¡í„°ì™€ ê°€ì¥ ì˜ ë§ëŠ” ì•„í‚¤íƒ€ì… ì°¾ê¸°
  const scores = ARCHETYPES.map(archetype => {
    const matchScore = archetype.matchingNeeds.reduce((score, matchNeed) => {
      const userNeed = needs.find(n => n.need === matchNeed);
      return score + (userNeed?.intensity || 0);
    }, 0);

    return { archetype, score: matchScore / archetype.matchingNeeds.length };
  });

  // ìƒìœ„ 2ê°œ ì¤‘ í™•ë¥ ì  ì„ íƒ (ë‹¤ì–‘ì„± í™•ë³´)
  const topTwo = scores.sort((a, b) => b.score - a.score).slice(0, 2);

  return randomWeightedChoice(topTwo.map(t => ({
    value: t.archetype,
    weight: t.score
  })));
}

function sampleObjects(
  archetype: Archetype,
  needs: Array<{need: string; intensity: number}>,
  count: number = 5
): string[] {

  const eligible = archetype.objects.filter(obj => {
    if (!obj.requirement) return true;

    // requirement í‰ê°€ (ì˜ˆ: "recognition > 0.7")
    const match = obj.requirement.match(/(\w+)\s*([><]=?)\s*([\d.]+)/);
    if (!match) return true;

    const [, need, operator, threshold] = match;
    const userNeed = needs.find(n => n.need === need);
    if (!userNeed) return false;

    switch (operator) {
      case '>': return userNeed.intensity > parseFloat(threshold);
      case '>=': return userNeed.intensity >= parseFloat(threshold);
      case '<': return userNeed.intensity < parseFloat(threshold);
      case '<=': return userNeed.intensity <= parseFloat(threshold);
      default: return true;
    }
  });

  // ê°€ì¤‘ì¹˜ ê¸°ë°˜ ìƒ˜í”Œë§
  return weightedRandomSample(eligible, count);
}
```

---

## Step 4: ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì¡°ë¦½

### êµ¬ì¡° í”„ë¡¬í”„íŠ¸ (ê³ ì •)

```typescript
const STRUCTURE_PROMPT = `
You are generating a pixel art room image for a character in a mobile game called "Knock".

[Style Requirements]
- Art Style: 16-bit pixel art (SNES era aesthetic)
- Resolution: 256x512 pixels (portrait/vertical orientation)
- Color Palette: Limited to 32 colors maximum
- Perspective: Isometric view
- Details: Clear pixel boundaries, no anti-aliasing, no blur

[Room Layout]
- View: Single room interior (bedroom or study)
- Walls: Back wall visible, one side wall partially visible
- Floor: Flat isometric floor tiles
- Ceiling: Optional, can be cropped at top

[Required Structure]
- One main focal point (desk OR bed)
- One seating element (chair OR floor cushion)
- At least one light source (lamp, window, screen glow)
- 2-5 decorative/functional items
- Window or door (for depth)

[Forbidden Elements]
- No text or readable words
- No human characters or figures
- No photorealistic elements
- No 3D rendering appearance
- No gradients or soft edges (pure pixel art)
`.trim();

const NEGATIVE_PROMPT = `
blurry, realistic, 3D render, photograph, anti-aliasing, gradients,
text, words, letters, watermark, signature, human, person, character,
low quality, distorted, deformed, duplicate, oversaturated
`.trim();
```

### ìµœì¢… í”„ë¡¬í”„íŠ¸ ì¡°ë¦½

```typescript
function assembleImagePrompt(
  visualLanguage: VisualLanguage,
  defensiveElements: DefensiveElement[],
  archetypeObjects: string[]
): string {

  return `
${STRUCTURE_PROMPT}

[CHARACTER'S INNER WORLD - Visual Language]
Color Palette:
- Primary: ${visualLanguage.colors.primary}
- Secondary: ${visualLanguage.colors.secondary}
- Accent: ${visualLanguage.colors.accent}

Space Atmosphere:
- Layout: ${visualLanguage.space.layout}
- Organization: ${visualLanguage.space.organization}
- Openness: ${visualLanguage.space.openness}

Lighting:
- Type: ${visualLanguage.lighting.type}
- Intensity: ${visualLanguage.lighting.intensity}
- Source: ${visualLanguage.lighting.source}

Overall Mood: ${visualLanguage.mood}

[KEY OBJECTS IN ROOM]
${archetypeObjects.map((obj, i) => `${i + 1}. ${obj}`).join('\n')}

[DEFENSIVE/PROTECTIVE ELEMENTS]
${defensiveElements.map(el => `- ${el.object} (${el.placement})`).join('\n')}

[TECHNICAL SPECIFICATIONS]
- Exact size: 256 pixels width Ã— 512 pixels height
- Strict pixel art style with visible pixel grid
- Isometric perspective (30-degree angle)
- Limited color palette (max 32 distinct colors)
- No anti-aliasing, no smooth edges
- Dithering for shading (classic pixel art technique)

Generate the pixel art room following ALL specifications above.
`.trim();
}
```

---

## Step 5: AI ì´ë¯¸ì§€ ìƒì„±

### Gemini Imagen í†µí•©

```typescript
import { ImageGenerationModel } from '@google-cloud/vertexai';

interface ImageGenerationConfig {
  prompt: string;
  negativePrompt: string;
  aspectRatio: string;
  guidanceScale: number;
  numberOfImages: number;
}

async function generateRoomImage(
  prompt: string
): Promise<{url: string; validated: boolean}> {

  const model = new ImageGenerationModel('imagen-3.0-generate-001');

  try {
    const result = await model.generateImages({
      prompt: prompt,
      negativePrompt: NEGATIVE_PROMPT,
      numberOfImages: 1,
      aspectRatio: '9:16',  // 256:512 ë¹„ìœ¨
      guidanceScale: 7.5,   // í”„ë¡¬í”„íŠ¸ ì¶©ì‹¤ë„ (7-10 ê¶Œì¥)
      seed: Date.now()      // ì¬í˜„ ê°€ëŠ¥ì„±
    });

    const imageData = result.images[0];

    // ì´ë¯¸ì§€ í’ˆì§ˆ ê²€ì¦
    const validation = await validateImageQuality(imageData);

    if (!validation.passed) {
      console.warn('Image quality check failed:', validation.issues);

      // ì¬ìƒì„± ì‹œë„ (1íšŒ)
      if (validation.retryable) {
        return await generateRoomImage(prompt);
      }

      // Fallback ì‚¬ìš©
      return {
        url: selectFallbackPreset(),
        validated: false
      };
    }

    // CDN ì—…ë¡œë“œ
    const url = await uploadToCDN(imageData, 'rooms');

    return { url, validated: true };

  } catch (error) {
    console.error('Image generation failed:', error);
    return {
      url: selectFallbackPreset(),
      validated: false
    };
  }
}
```

### ì´ë¯¸ì§€ í’ˆì§ˆ ê²€ì¦

```typescript
interface ImageValidation {
  passed: boolean;
  retryable: boolean;
  issues: string[];
}

async function validateImageQuality(
  imageData: Buffer
): Promise<ImageValidation> {

  const issues: string[] = [];
  let retryable = false;

  // 1. í•´ìƒë„ í™•ì¸
  const dimensions = await getImageDimensions(imageData);
  if (dimensions.width !== 256 || dimensions.height !== 512) {
    issues.push(`Invalid dimensions: ${dimensions.width}x${dimensions.height}`);
    retryable = false; // í•´ìƒë„ ë¬¸ì œëŠ” ì¬ìƒì„±í•´ë„ ë™ì¼
  }

  // 2. íŒŒì¼ í¬ê¸° í™•ì¸ (200KB ì´í•˜ ê¶Œì¥)
  const sizeKB = imageData.length / 1024;
  if (sizeKB > 200) {
    issues.push(`File too large: ${sizeKB.toFixed(1)}KB`);
    retryable = true;
  }

  // 3. ìƒ‰ìƒ ìˆ˜ í™•ì¸ (32ìƒ‰ ì´í•˜)
  const colorCount = await countUniqueColors(imageData);
  if (colorCount > 40) {  // ì•½ê°„ì˜ ì—¬ìœ 
    issues.push(`Too many colors: ${colorCount} (max 32)`);
    retryable = true;
  }

  // 4. í”½ì…€ì•„íŠ¸ ìŠ¤íƒ€ì¼ ê°ì§€ (ê°„ë‹¨í•œ ì—£ì§€ ê²€ì¶œ)
  const isPixelArt = await detectPixelArtStyle(imageData);
  if (!isPixelArt) {
    issues.push('Not pixel art style');
    retryable = true;
  }

  return {
    passed: issues.length === 0,
    retryable,
    issues
  };
}

async function detectPixelArtStyle(
  imageData: Buffer
): Promise<boolean> {

  // ê°„ë‹¨í•œ ì—£ì§€ ê²€ì¶œ: í”½ì…€ì•„íŠ¸ëŠ” sharp edgeê°€ ë§ìŒ
  const image = await loadImage(imageData);
  const edges = detectEdges(image);

  // sharp edge ë¹„ìœ¨ì´ ë†’ìœ¼ë©´ í”½ì…€ì•„íŠ¸ë¡œ íŒë‹¨
  const sharpEdgeRatio = edges.sharp / edges.total;

  return sharpEdgeRatio > 0.7;  // 70% ì´ìƒ sharp edge
}
```

### Fallback í”„ë¦¬ì…‹ ì‹œìŠ¤í…œ

```typescript
interface PresetImage {
  url: string;
  archetype: string;
  needs: string[];
}

const PRESET_IMAGES: PresetImage[] = [
  {
    url: 'https://cdn.knock.com/rooms/preset-dev-gamer-1.png',
    archetype: 'developer_gamer',
    needs: ['recognition', 'belonging']
  },
  {
    url: 'https://cdn.knock.com/rooms/preset-minimalist-1.png',
    archetype: 'minimalist_achiever',
    needs: ['recognition', 'autonomy']
  },
  {
    url: 'https://cdn.knock.com/rooms/preset-cozy-1.png',
    archetype: 'cozy_creative',
    needs: ['belonging', 'growth']
  },
  {
    url: 'https://cdn.knock.com/rooms/preset-learner-1.png',
    archetype: 'focused_learner',
    needs: ['growth', 'meaning']
  },
  {
    url: 'https://cdn.knock.com/rooms/preset-safe-1.png',
    archetype: 'safe_organized',
    needs: ['survival', 'autonomy']
  }
];

function selectFallbackPreset(
  needs?: Array<{need: string; intensity: number}>
): string {

  if (!needs || needs.length === 0) {
    // ëœë¤ ì„ íƒ
    return randomChoice(PRESET_IMAGES).url;
  }

  // ìš•êµ¬ ë²¡í„°ì™€ ê°€ì¥ ê°€ê¹Œìš´ í”„ë¦¬ì…‹ ì°¾ê¸°
  const topNeeds = needs
    .sort((a, b) => b.intensity - a.intensity)
    .slice(0, 2)
    .map(n => n.need);

  const matches = PRESET_IMAGES.filter(preset =>
    topNeeds.some(need => preset.needs.includes(need))
  );

  if (matches.length === 0) {
    return randomChoice(PRESET_IMAGES).url;
  }

  return randomChoice(matches).url;
}
```

---

## ğŸ”§ ì™„ì „ í†µí•© API

### ì—”ë“œí¬ì¸íŠ¸

```typescript
POST /api/v1/admin/characters/:id/generate-image

Request:
{
  "regenerate": false  // trueë©´ ê¸°ì¡´ ì´ë¯¸ì§€ ë¬´ì‹œí•˜ê³  ì¬ìƒì„±
}

Response:
{
  "success": true,
  "image": {
    "url": "https://cdn.knock.com/rooms/abc123.png",
    "validated": true,
    "prompt": "...",
    "metadata": {
      "visualLanguage": {...},
      "defensiveElements": [...],
      "archetype": "developer_gamer",
      "objects": [...]
    }
  }
}
```

### êµ¬í˜„

```typescript
async function generateCharacterRoomImage(
  characterId: string,
  regenerate: boolean = false
): Promise<ImageGenerationResult> {

  // 1. ìºë¦­í„° ë°ì´í„° ë¡œë“œ
  const character = await loadCharacter(characterId);

  if (character.imageUrl && !regenerate) {
    return {
      url: character.imageUrl,
      validated: true,
      cached: true
    };
  }

  // 2. ìš•êµ¬ ë²¡í„° ì¶”ì¶œ
  const needs = character.analysis.completeVector
    .filter(v => v.actual > 0.3)
    .sort((a, b) => b.actual - a.actual)
    .slice(0, 3)
    .map(v => ({ need: v.need, intensity: v.actual }));

  // 3. ì‹œê°ì  ì–¸ì–´ ìƒì„±
  const visualLanguage = blendVisualLanguages(needs);

  // 4. íŠ¸ë¼ìš°ë§ˆ â†’ ë°©ì–´ ìš”ì†Œ
  const traumaTypes = inferTraumaTypes(character.analysis);
  const defensiveElements = selectDefensiveElements(traumaTypes);

  // 5. ì•„í‚¤íƒ€ì… ì„ íƒ ë° ì˜¤ë¸Œì íŠ¸ ìƒ˜í”Œë§
  const archetype = selectArchetype(needs);
  const objects = sampleObjects(archetype, needs, 5);

  // 6. ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì¡°ë¦½
  const imagePrompt = assembleImagePrompt(
    visualLanguage,
    defensiveElements,
    objects
  );

  // 7. ì´ë¯¸ì§€ ìƒì„±
  const { url, validated } = await generateRoomImage(imagePrompt);

  // 8. DB ì—…ë°ì´íŠ¸
  await updateCharacterImage(characterId, {
    url,
    prompt: imagePrompt,
    metadata: {
      visualLanguage,
      defensiveElements,
      archetype: archetype.name,
      objects
    }
  });

  return { url, validated, imagePrompt, metadata: {...} };
}
```

---

## ğŸ“Š ë¹„ìš© ë° ì„±ëŠ¥

### ì˜ˆìƒ ë¹„ìš© (Gemini Imagen)

```
ë¬´ë£Œ í‹°ì–´: 100íšŒ/ì›”
ìœ ë£Œ: $0.020 per image

ì›” ì‹ ê·œ ìºë¦­í„° ìƒì„±: 100ê°œ ê°€ì •
- ë¬´ë£Œ: $0
- ìœ ë£Œ: 0 * $0.020 = $0 (ë¬´ë£Œ ë²”ìœ„ ë‚´)

ì¬ìƒì„± í¬í•¨ 200íšŒ/ì›”:
- 100íšŒ ë¬´ë£Œ
- 100íšŒ * $0.020 = $2/ì›”
```

### ìƒì„± ì†ë„

```
í‰ê·  ìƒì„± ì‹œê°„: 5-10ì´ˆ
í’ˆì§ˆ ê²€ì¦: 1-2ì´ˆ
CDN ì—…ë¡œë“œ: 1-2ì´ˆ

ì´ ì†Œìš” ì‹œê°„: 7-14ì´ˆ (acceptable)
```

---

## âœ… í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ìƒì„± ì „
- [ ] ìš•êµ¬ ë²¡í„° 2ê°œ ì´ìƒ (0.5 ì´ìƒ)
- [ ] ì‹œê°ì  ì–¸ì–´ ë§¤í•‘ ì™„ë£Œ
- [ ] íŠ¸ë¼ìš°ë§ˆ íƒ€ì… ì‹ë³„
- [ ] ì•„í‚¤íƒ€ì… ì„ íƒ ì™„ë£Œ

### ìƒì„± í›„
- [ ] 256x512 í•´ìƒë„ í™•ì¸
- [ ] 32ìƒ‰ ì´í•˜ í™•ì¸ (40ìƒ‰ê¹Œì§€ í—ˆìš©)
- [ ] í”½ì…€ì•„íŠ¸ ìŠ¤íƒ€ì¼ í™•ì¸
- [ ] íŒŒì¼ í¬ê¸° 200KB ì´í•˜
- [ ] ìš•êµ¬ì™€ ìƒ‰ìƒ ì¼ì¹˜ì„± í™•ì¸

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

1. âœ… ì´ ë¬¸ì„œ ì™„ì„±
2. â†’ [04_INITIAL_ROOM_IMPLEMENTATION.md](./04_INITIAL_ROOM_IMPLEMENTATION.md) ì°¸ì¡°
3. Gemini Imagen API ê³„ì • ì„¤ì •
4. í”„ë¦¬ì…‹ ì´ë¯¸ì§€ 5ê°œ ì œì‘
5. ì´ë¯¸ì§€ ìƒì„± íŒŒì´í”„ë¼ì¸ êµ¬í˜„
6. í’ˆì§ˆ ê²€ì¦ ë¡œì§ êµ¬í˜„

---

**ì°¸ì¡° ë¬¸ì„œ**:
- [COMPLETE_GUIDE.md](../01_Feature/02_Roommate/SystemPromptArchitecture/COMPLETE_GUIDE.md)
- [room-generation/README.md](../01_Feature/02_Roommate/room-generation/README.md)
- [02_CHARACTER_GENERATOR_FLOW.md](./02_CHARACTER_GENERATOR_FLOW.md)
